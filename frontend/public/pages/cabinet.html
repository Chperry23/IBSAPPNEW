<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet PM App - Cabinet Inspection</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/theme-system.js"></script>
    <script src="/sound-system.js"></script>
    <style>
        .voltage-valid {
            border-color: #28a745 !important;
            background-color: #f8fff9 !important;
        }
        .voltage-invalid {
            border-color: #dc3545 !important;
            background-color: #fff8f8 !important;
        }
        .mt-2 {
            margin-top: 0.5rem;
        }
        
        /* Collapsible Section Styles */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .collapsible-header:hover {
            background-color: #f8f9fa;
        }
        
        .collapse-toggle {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: transform 0.2s ease, background-color 0.2s ease;
            color: #6b7280;
        }
        
        .collapse-toggle:hover {
            background-color: #e5e7eb;
            color: #374151;
        }
        
        .collapse-toggle.collapsed {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
            max-height: none;
            opacity: 1;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        
        .section-status {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            margin-left: 0.5rem;
        }
        
        .section-status.complete {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .section-status.partial {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .section-status.empty {
            background-color: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Simple Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="/dashboard.html" class="nav-brand">ECI Cabinet PM</a>
            <div class="nav-links">
                <a href="#" id="nav-customer-profile" style="display: none;">Customer Profile</a>
                <span id="nav-cabinet-name" class="text-gray-600 text-sm"></span>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <header class="page-header flex justify-between items-center">
            <div>
                <h1 id="cabinet-title" class="text-3xl font-bold text-gray-900 mb-2">Cabinet Inspection</h1>
                <p id="cabinet-info" class="text-gray-600"></p>
            </div>
            <div class="flex gap-3">
                <button id="expand-all-btn" class="btn btn-outline">üìñ Expand All</button>
                <button id="collapse-all-btn" class="btn btn-outline">üìï Collapse All</button>
                <button id="save-cabinet-btn" class="btn btn-primary">üíæ Save</button>
                <button id="save-pdf-btn" class="btn btn-success">üìÑ Save as PDF</button>
                <button id="back-to-session-btn" class="btn btn-secondary">‚Üê Back to Session</button>
            </div>
        </header>

        <main>
            <form id="cabinet-form">
                <!-- Basic Cabinet Info -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="cabinet-info">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Cabinet Information</h2>
                            <span class="section-status empty" id="cabinet-info-status">Empty</span>
                    </div>
                        <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    <div class="card-body collapsible-content" id="cabinet-info-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label for="cabinet-location" class="form-label">Cabinet Location</label>
                                <input type="text" id="cabinet-location" name="cabinet_location" required class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="cabinet-date" class="form-label">Date</label>
                                <input type="date" id="cabinet-date" name="cabinet_date" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Controllers Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="controllers">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Controllers</h2>
                            <span class="section-status empty" id="controllers-status">Empty</span>
                        </div>
                        <div class="flex items-center gap-2">
                        <button type="button" id="add-controller" class="btn btn-secondary btn-sm">‚ûï Add Controller</button>
                            <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    </div>
                    <div class="card-body collapsible-content" id="controllers-content">
                        <div id="controllers-container" class="space-y-4">
                            <!-- Controllers will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Power Supplies Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="power-supplies">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Power Supplies</h2>
                            <span class="section-status empty" id="power-supplies-status">Empty</span>
                        </div>
                        <div class="flex items-center gap-2">
                        <button type="button" id="add-power-supply" class="btn btn-secondary btn-sm">‚ûï Add Power Supply</button>
                            <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    </div>
                    <div class="card-body collapsible-content" id="power-supplies-content">
                        <div id="power-supplies-container" class="space-y-4">
                            <!-- Power supplies will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Distribution Blocks Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="distribution-blocks">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Distribution Blocks/Diodes</h2>
                            <span class="section-status empty" id="distribution-blocks-status">Empty</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button" id="add-distribution-block" class="btn btn-secondary btn-sm">‚ûï Add Distribution Block</button>
                            <button type="button" id="add-diode" class="btn btn-secondary btn-sm">‚ûï Add Diode</button>
                            <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                        </div>
                    </div>
                    <div class="card-body collapsible-content" id="distribution-blocks-content">
                        <div id="distribution-blocks-container" class="space-y-4 mb-4">
                            <!-- Distribution blocks will be dynamically added here -->
                        </div>
                        <div id="diodes-container" class="space-y-4">
                            <!-- Diodes will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Inspection Items Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="inspection-items">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Inspection Items</h2>
                            <span class="section-status empty" id="inspection-items-status">Empty</span>
                    </div>
                        <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    <div class="card-body collapsible-content" id="inspection-items-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="form-group">
                                <label class="form-label">All cabinet fans are running (if installed)</label>
                                <select name="cabinet_fans" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Inspect Controller Status LEDs</label>
                                <select name="controller_leds" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Inspect I/O Status LEDs</label>
                                <select name="io_status" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Inspect Network Equipment Status</label>
                                <select name="network_status" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Environmental Temperatures Nominal (Note if abnormal)</label>
                                <select name="temperatures" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cleaned Enclosure</label>
                                <select name="is_clean" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">A clean filter is installed in cabinet</label>
                                <select name="clean_filter_installed" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ground Inspection</label>
                                <select name="ground_inspection" class="form-select">
                                    <option value="">Select...</option>
                                    <option value="pass">PASS</option>
                                    <option value="fail">FAIL</option>
                                    <option value="na">N/A</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Network Equipment Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="network-equipment">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Network Equipment</h2>
                            <span class="section-status empty" id="network-equipment-status">Empty</span>
                        </div>
                        <div class="flex items-center gap-2">
                        <button type="button" id="add-network-equipment" class="btn btn-secondary btn-sm">‚ûï Add Network Equipment</button>
                            <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    </div>
                    <div class="card-body collapsible-content" id="network-equipment-content">
                        <div id="network-equipment-container" class="space-y-4">
                            <!-- Network equipment will be dynamically added here -->
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="card mb-6">
                    <div class="card-header collapsible-header" data-section="comments">
                        <div class="flex items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Comments</h2>
                            <span class="section-status empty" id="comments-status">Empty</span>
                    </div>
                        <button type="button" class="collapse-toggle" aria-label="Toggle section">‚ûñ</button>
                    </div>
                    <div class="card-body collapsible-content" id="comments-content">
                        <div class="form-group">
                            <textarea name="comments" rows="4" placeholder="Additional notes and comments..." class="form-textarea"></textarea>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Footer Navigation -->
            <div class="card mt-8">
                <div class="card-body">
                    <div class="flex justify-center gap-4">
                        <button id="footer-save-btn" class="btn btn-primary">üíæ Save</button>
                        <button id="footer-back-to-session-btn" class="btn btn-secondary">‚Üê Back to Cabinets</button>
                        <button id="footer-back-to-customer-btn" class="btn btn-outline">üë§ Back to Customer Profile</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="message" class="message"></div>

    <!-- Controller Selection Modal -->
    <div id="controller-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="controller-modal-title">Select Controller</h3>
                <button type="button" class="close-modal" onclick="closeControllerModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="text" id="controller-search" placeholder="Search controllers..." 
                           class="form-input" onkeyup="filterControllers()">
                </div>
                
                <div class="mb-4">
                    <div class="flex gap-2">
                        <button type="button" class="btn btn-outline btn-sm" onclick="showControllerCategory('all')">All</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="showControllerCategory('available')">Available</button>
                        <button type="button" class="btn btn-outline btn-sm" onclick="showControllerCategory('used')">Used</button>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="openControllerManagement()">Manage Controllers</button>
                    </div>
                </div>
                
                <div id="controller-list" class="space-y-2" style="max-height: 400px; overflow-y: auto;">
                    <!-- Controllers will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeControllerModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="selectController()" disabled id="select-controller-btn">Select</button>
            </div>
        </div>
    </div>

    <!-- Controller Management Modal -->
    <div id="controller-management-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Controller Management</h3>
                <button type="button" class="close-modal" onclick="closeControllerManagement()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="text" id="management-search" placeholder="Search controllers..." 
                           class="form-input" onkeyup="filterManagementControllers()">
                </div>
                
                <div id="management-controller-list" style="max-height: 500px; overflow-y: auto;">
                    <!-- Controller management list will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeControllerManagement()">Close</button>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let currentCabinetId = null;
        let cabinetData = null;
        let currentCustomerId = null;
        let availableControllers = [];
        let powerSupplyCounter = 0;
        let distributionBlockCounter = 0;
        let diodeCounter = 0;
        let networkEquipmentCounter = 0;
        let controllerCounter = 0;
        let isSessionCompleted = false;

        // Initialize cabinet page
        document.addEventListener('DOMContentLoaded', function() {
            // Get IDs from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentSessionId = urlParams.get('session');
            currentCabinetId = urlParams.get('cabinet');
            
            if (!currentSessionId || !currentCabinetId) {
                window.location.href = '/dashboard';
                return;
            }
            
            checkSessionStatus().then(() => {
            loadCabinet();
            setupEventListeners();
                setupCollapsibleSections();
        });
        });

        async function checkSessionStatus() {
            try {
                const response = await fetch(`/api/sessions/${currentSessionId}/status`);
                if (response.ok) {
                    const statusData = await response.json();
                    isSessionCompleted = statusData.isCompleted;
                    
                    if (isSessionCompleted) {
                        enableViewOnlyMode();
                    }
                }
            } catch (error) {
                console.error('Error checking session status:', error);
            }
        }

        function enableViewOnlyMode() {
            // Add visual indicator
            const header = document.querySelector('.page-header');
            if (header) {
                const indicator = document.createElement('div');
                indicator.className = 'view-only-banner';
                indicator.innerHTML = `
                    <div class="alert alert-info mb-4">
                        <strong>üìã View Only Mode</strong> - This PM session has been completed and cannot be modified.
                    </div>
                `;
                header.appendChild(indicator);
            }
            
            // Disable interactive elements after DOM is loaded
            setTimeout(() => {
                disableCabinetInteractiveElements();
            }, 500);
        }

        function disableCabinetInteractiveElements() {
            // Disable all buttons except navigation and export
            const buttonsToDisable = document.querySelectorAll('button');
            buttonsToDisable.forEach(btn => {
                if (!btn.textContent.includes('Back') && 
                    !btn.textContent.includes('PDF') &&
                    !btn.textContent.includes('Expand') &&
                    !btn.textContent.includes('Collapse')) {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                }
            });
            
            // Disable all form inputs
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
                input.style.opacity = '0.5';
            });
            
            // Hide add buttons
            const addButtons = document.querySelectorAll('[id^="add-"]');
            addButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Hide remove buttons that will be added dynamically
            setTimeout(() => {
                const removeButtons = document.querySelectorAll('.remove-btn, [onclick*="remove"]');
                removeButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
            }, 1000);
        }

        function setupEventListeners() {
            console.log('DEBUG: Setting up cabinet event listeners');
            
            // Navigation
            document.getElementById('back-to-session-btn').addEventListener('click', () => {
                console.log('DEBUG: Back to session clicked');
                window.location.href = `session.html?id=${currentSessionId}`;
            });
            
            // Save actions
            document.getElementById('save-cabinet-btn').addEventListener('click', saveCabinet);
            document.getElementById('save-pdf-btn').addEventListener('click', saveToPDF);
            
            // Footer buttons
            document.getElementById('footer-save-btn').addEventListener('click', saveCabinet);
            document.getElementById('footer-back-to-session-btn').addEventListener('click', () => {
                window.location.href = `session.html?id=${currentSessionId}`;
            });
            document.getElementById('footer-back-to-customer-btn').addEventListener('click', () => {
                if (currentCustomerId) {
                    window.location.href = `customer-detail.html?customer=${currentCustomerId}`;
                } else {
                    showMessage('Customer information not available', 'error');
                }
            });
            
            // Add component buttons
            document.getElementById('add-power-supply').addEventListener('click', addPowerSupply);
            document.getElementById('add-distribution-block').addEventListener('click', addDistributionBlock);
            document.getElementById('add-diode').addEventListener('click', addDiode);
            document.getElementById('add-network-equipment').addEventListener('click', addNetworkEquipment);
            document.getElementById('add-controller').addEventListener('click', addController);
            
            // Expand/Collapse all buttons
            document.getElementById('expand-all-btn').addEventListener('click', expandAllSections);
            document.getElementById('collapse-all-btn').addEventListener('click', collapseAllSections);
        }

        function setupCollapsibleSections() {
            // Add click handlers to all collapsible headers
            document.querySelectorAll('.collapsible-header').forEach(header => {
                const toggleBtn = header.querySelector('.collapse-toggle');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleSection(header);
                    });
                }
            });
            
            // Set up form change listeners for section status updates
            setupSectionStatusTracking();
        }

        function toggleSection(header) {
            const sectionName = header.dataset.section;
            const content = document.getElementById(`${sectionName}-content`);
            const toggle = header.querySelector('.collapse-toggle');
            
            if (!content || !toggle) return;
            
            const isCollapsed = content.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ûñ';
            } else {
                // Collapse
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ûï';
            }
        }

        function expandAllSections() {
            document.querySelectorAll('.collapsible-content').forEach(content => {
                content.classList.remove('collapsed');
            });
            document.querySelectorAll('.collapse-toggle').forEach(toggle => {
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ûñ';
            });
        }

        function collapseAllSections() {
            document.querySelectorAll('.collapsible-content').forEach(content => {
                content.classList.add('collapsed');
            });
            document.querySelectorAll('.collapse-toggle').forEach(toggle => {
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ûï';
            });
        }

        function setupSectionStatusTracking() {
            // Monitor form changes to update section status indicators
            const form = document.getElementById('cabinet-form');
            
            // Use event delegation for dynamic content
            form.addEventListener('input', (e) => {
                updateSectionStatus();
            });
            
            form.addEventListener('change', (e) => {
                updateSectionStatus();
            });
            
            // Initial status update
            setTimeout(updateSectionStatus, 500);
        }

        function updateSectionStatus() {
            // Cabinet Information
            updateCabinetInfoStatus();
            
            // Controllers
            updateControllersStatus();
            
            // Power Supplies
            updatePowerSuppliesStatus();
            
            // Distribution Blocks
            updateDistributionBlocksStatus();
            
            // Inspection Items
            updateInspectionItemsStatus();
            
            // Network Equipment
            updateNetworkEquipmentStatus();
            
            // Comments
            updateCommentsStatus();
        }

        function updateCabinetInfoStatus() {
            const location = document.getElementById('cabinet-location').value;
            const date = document.getElementById('cabinet-date').value;
            const status = document.getElementById('cabinet-info-status');
            
            if (location && date) {
                status.textContent = 'Complete';
                status.className = 'section-status complete';
            } else if (location || date) {
                status.textContent = 'Partial';
                status.className = 'section-status partial';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updateControllersStatus() {
            const container = document.getElementById('controllers-container');
            const status = document.getElementById('controllers-status');
            const count = container.children.length;
            
            if (count > 0) {
                status.textContent = `${count} Controller${count > 1 ? 's' : ''}`;
                status.className = 'section-status complete';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updatePowerSuppliesStatus() {
            const container = document.getElementById('power-supplies-container');
            const status = document.getElementById('power-supplies-status');
            const count = container.children.length;
            
            if (count > 0) {
                status.textContent = `${count} Power Suppl${count > 1 ? 'ies' : 'y'}`;
                status.className = 'section-status complete';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updateDistributionBlocksStatus() {
            const blocksContainer = document.getElementById('distribution-blocks-container');
            const diodesContainer = document.getElementById('diodes-container');
            const status = document.getElementById('distribution-blocks-status');
            
            const blocksCount = blocksContainer.children.length;
            const diodesCount = diodesContainer.children.length;
            const totalCount = blocksCount + diodesCount;
            
            if (totalCount > 0) {
                let text = '';
                if (blocksCount > 0) text += `${blocksCount} Block${blocksCount > 1 ? 's' : ''}`;
                if (diodesCount > 0) {
                    if (text) text += ', ';
                    text += `${diodesCount} Diode${diodesCount > 1 ? 's' : ''}`;
                }
                status.textContent = text;
                status.className = 'section-status complete';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updateInspectionItemsStatus() {
            const selects = document.querySelectorAll('#inspection-items-content select');
            const status = document.getElementById('inspection-items-status');
            
            let completed = 0;
            let total = selects.length;
            
            selects.forEach(select => {
                if (select.value && select.value !== '') {
                    completed++;
                }
            });
            
            if (completed === total) {
                status.textContent = 'Complete';
                status.className = 'section-status complete';
            } else if (completed > 0) {
                status.textContent = `${completed}/${total} Items`;
                status.className = 'section-status partial';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updateNetworkEquipmentStatus() {
            const container = document.getElementById('network-equipment-container');
            const status = document.getElementById('network-equipment-status');
            const count = container.children.length;
            
            if (count > 0) {
                status.textContent = `${count} Equipment`;
                status.className = 'section-status complete';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        function updateCommentsStatus() {
            const textarea = document.querySelector('textarea[name="comments"]');
            const status = document.getElementById('comments-status');
            
            if (textarea && textarea.value.trim()) {
                status.textContent = 'Has Comments';
                status.className = 'section-status complete';
            } else {
                status.textContent = 'Empty';
                status.className = 'section-status empty';
            }
        }

        // Update section status when components are added/removed
        function updateSectionStatusAfterChange() {
            setTimeout(() => {
                updateSectionStatus();
            }, 100);
        }

        async function loadCabinet() {
            try {
                const response = await fetch(`/api/cabinets/${currentCabinetId}`);
                if (!response.ok) {
                    throw new Error('Cabinet not found');
                }
                
                cabinetData = await response.json();
                
                // Get customer ID from session data
                const sessionResponse = await fetch(`/api/sessions/${currentSessionId}`);
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    currentCustomerId = sessionData.customer_id;
                    
                    // Setup customer profile navigation
                    const customerProfileLink = document.getElementById('nav-customer-profile');
                    if (customerProfileLink && sessionData.customer_name) {
                        customerProfileLink.style.display = 'block';
                        customerProfileLink.textContent = `${sessionData.customer_name} Profile`;
                        customerProfileLink.href = `/customer-detail.html?customer=${currentCustomerId}`;
                    }
                    
                    // Load available controllers for this customer
                    await loadAvailableControllers();
                }
                
                // Update page title and info
                document.getElementById('cabinet-title').textContent = 
                    `Cabinet: ${cabinetData.cabinet_location}`;
                document.getElementById('cabinet-info').textContent = 
                    `Date: ${cabinetData.cabinet_date ? new Date(cabinetData.cabinet_date).toLocaleDateString() : 'Not set'}`;
                
                // Update navigation
                document.getElementById('nav-cabinet-name').textContent = cabinetData.cabinet_location;
                
                // Populate form with existing data
                populateForm();
                
            } catch (error) {
                showMessage('Error loading cabinet', 'error');
                setTimeout(() => {
                    window.location.href = `session.html?id=${currentSessionId}`;
                }, 2000);
            }
        }

        async function loadAvailableControllers() {
            if (!currentCustomerId) return;
            
            try {
                const url = currentSessionId ? 
                    `/api/customers/${currentCustomerId}/available-controllers?sessionId=${currentSessionId}` :
                    `/api/customers/${currentCustomerId}/available-controllers`;
                const response = await fetch(url);
                if (response.ok) {
                    availableControllers = await response.json();
                    // Also update the modal data
                    await loadControllersWithStatus();
                }
            } catch (error) {
                console.error('Error loading available controllers:', error);
            }
        }

        function populateForm() {
            // Basic info
            document.getElementById('cabinet-location').value = cabinetData.cabinet_location || '';
            document.getElementById('cabinet-date').value = cabinetData.cabinet_date || '';
            
            // Power supplies
            if (cabinetData.power_supplies) {
                cabinetData.power_supplies.forEach(ps => {
                    addPowerSupply(ps);
                });
            }
            
            // Distribution blocks
            if (cabinetData.distribution_blocks) {
                cabinetData.distribution_blocks.forEach(db => {
                    addDistributionBlock(db);
                });
            }
            
            // Diodes
            if (cabinetData.diodes) {
                cabinetData.diodes.forEach(diode => {
                    addDiode(diode);
                });
            }
            
            // Inspection items
            if (cabinetData.inspection) {
                const inspection = cabinetData.inspection;
                const form = document.getElementById('cabinet-form');
                
                Object.keys(inspection).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input && inspection[key]) {
                        input.value = inspection[key];
                    }
                });
            }
            
            // Network equipment
            if (cabinetData.network_equipment) {
                cabinetData.network_equipment.forEach(equipment => {
                    addNetworkEquipment(equipment);
                });
            }
            
            // Controllers
            if (cabinetData.controllers) {
                cabinetData.controllers.forEach(controller => {
                    addController(controller);
                });
            }
            
            // Add voltage validation to existing inputs
            setTimeout(() => {
                addVoltageValidation();
            }, 100);
        }

        function addPowerSupply(data = {}) {
            powerSupplyCounter++;
            const container = document.getElementById('power-supplies-container');
            
            const powerSupplyDiv = document.createElement('div');
            powerSupplyDiv.className = 'component-card border border-gray-200 rounded-lg p-4 bg-gray-50';
            powerSupplyDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-medium text-gray-900">Power Supply ${powerSupplyCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeComponent(this)">üóëÔ∏è Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Voltage Type</label>
                        <select name="power_supplies[${powerSupplyCounter}][voltage_type]" class="form-select"
                                onchange="validateAllPowerSupplyVoltages(this.closest('.component-card'))">
                            <option value="24VDC" ${data.voltage_type === '24VDC' || !data.voltage_type ? 'selected' : ''}>24VDC</option>
                            <option value="12VDC" ${data.voltage_type === '12VDC' ? 'selected' : ''}>12VDC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="power_supplies[${powerSupplyCounter}][status]" class="form-select">
                            <option value="pass" ${data.status === 'pass' ? 'selected' : ''}>PASS</option>
                            <option value="fail" ${data.status === 'fail' ? 'selected' : ''}>FAIL</option>
                            <option value="na" ${data.status === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Line to Neutral (V)</label>
                        <input type="number" step="0.01" name="power_supplies[${powerSupplyCounter}][line_neutral]" 
                               value="${data.line_neutral || ''}" class="form-input" placeholder="0.00"
                               oninput="validateACVoltage(this, 'line_neutral')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Line to Ground (V)</label>
                        <input type="number" step="0.01" name="power_supplies[${powerSupplyCounter}][line_ground]" 
                               value="${data.line_ground || ''}" class="form-input" placeholder="0.00"
                               oninput="validateACVoltage(this, 'line_ground')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Neutral to Ground (mV)</label>
                        <input type="number" step="1" name="power_supplies[${powerSupplyCounter}][neutral_ground]" 
                               value="${data.neutral_ground || ''}" class="form-input" placeholder="0"
                               oninput="validateACVoltage(this, 'neutral_ground')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">DC Reading (V)</label>
                        <input type="number" step="0.01" name="power_supplies[${powerSupplyCounter}][dc_reading]" 
                               value="${data.dc_reading || ''}" class="form-input" placeholder="0.00"
                               oninput="validateDCVoltage(this, this.closest('.component-card').querySelector('select[name*=voltage_type]').value)">
                    </div>
                </div>
            `;
            
            container.appendChild(powerSupplyDiv);
            updateSectionStatusAfterChange();
        }

        function addDistributionBlock(data = {}) {
            distributionBlockCounter++;
            const container = document.getElementById('distribution-blocks-container');
            
            const blockDiv = document.createElement('div');
            blockDiv.className = 'component-card border border-gray-200 rounded-lg p-4 bg-gray-50';
            blockDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-medium text-gray-900">Distribution Block ${distributionBlockCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeComponent(this)">üóëÔ∏è Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">DC Reading (V)</label>
                        <input type="number" step="0.01" name="distribution_blocks[${distributionBlockCounter}][dc_reading]" 
                               value="${data.dc_reading || ''}" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="distribution_blocks[${distributionBlockCounter}][status]" class="form-select">
                            <option value="pass" ${data.status === 'pass' ? 'selected' : ''}>PASS</option>
                            <option value="fail" ${data.status === 'fail' ? 'selected' : ''}>FAIL</option>
                            <option value="na" ${data.status === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(blockDiv);
            updateSectionStatusAfterChange();
        }

        function addDiode(data = {}) {
            diodeCounter++;
            const container = document.getElementById('diodes-container');
            
            const diodeDiv = document.createElement('div');
            diodeDiv.className = 'component-card border border-gray-200 rounded-lg p-4 bg-gray-50';
            diodeDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-medium text-gray-900">Diode ${diodeCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeComponent(this)">üóëÔ∏è Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">DC Reading (V)</label>
                        <input type="number" step="0.01" name="diodes[${diodeCounter}][dc_reading]" 
                               value="${data.dc_reading || ''}" class="form-input" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="diodes[${diodeCounter}][status]" class="form-select">
                            <option value="pass" ${data.status === 'pass' ? 'selected' : ''}>PASS</option>
                            <option value="fail" ${data.status === 'fail' ? 'selected' : ''}>FAIL</option>
                            <option value="na" ${data.status === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(diodeDiv);
            updateSectionStatusAfterChange();
        }

        function addNetworkEquipment(data = {}) {
            networkEquipmentCounter++;
            const container = document.getElementById('network-equipment-container');
            
            const equipmentDiv = document.createElement('div');
            equipmentDiv.className = 'component-card border border-gray-200 rounded-lg p-4 bg-gray-50';
            equipmentDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-medium text-gray-900">Network Equipment ${networkEquipmentCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeComponent(this)">üóëÔ∏è Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-group">
                        <label class="form-label">Equipment Type</label>
                        <select name="network_equipment[${networkEquipmentCounter}][equipment_type]" class="form-select">
                            <option value="switch" ${data.equipment_type === 'switch' ? 'selected' : ''}>Switch</option>
                            <option value="hub" ${data.equipment_type === 'hub' ? 'selected' : ''}>Hub</option>
                            <option value="router" ${data.equipment_type === 'router' ? 'selected' : ''}>Router</option>
                            <option value="fiber" ${data.equipment_type === 'fiber' ? 'selected' : ''}>Fiber</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Model Number</label>
                        <select name="network_equipment[${networkEquipmentCounter}][model_number]" class="form-select" onchange="handleModelSelection(this)">
                            <option value="">Select Model</option>
                            <option value="Fp20" ${data.model_number === 'Fp20' ? 'selected' : ''}>Fp20</option>
                            <option value="Fp40" ${data.model_number === 'Fp40' ? 'selected' : ''}>Fp40</option>
                            <option value="Rm100" ${data.model_number === 'Rm100' ? 'selected' : ''}>Rm100</option>
                            <option value="Rm200" ${data.model_number === 'Rm200' ? 'selected' : ''}>Rm200</option>
                            <option value="Entron" ${data.model_number === 'Entron' ? 'selected' : ''}>Entron</option>
                            <option value="Bradley" ${data.model_number === 'Bradley' ? 'selected' : ''}>Bradley</option>
                            <option value="6019" ${data.model_number === '6019' ? 'selected' : ''}>6019</option>
                            <option value="custom">Other (Custom)</option>
                        </select>
                        <input type="text" name="network_equipment[${networkEquipmentCounter}][model_number_custom]" 
                               value="${!['Fp20', 'Fp40', 'Rm100', 'Rm200', 'Entron', 'Bradley', '6019'].includes(data.model_number) && data.model_number ? data.model_number : ''}" 
                               class="form-input mt-2" placeholder="Enter custom model" style="display: ${!['Fp20', 'Fp40', 'Rm100', 'Rm200', 'Entron', 'Bradley', '6019'].includes(data.model_number) && data.model_number ? 'block' : 'none'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="network_equipment[${networkEquipmentCounter}][status]" class="form-select">
                            <option value="pass" ${data.status === 'pass' ? 'selected' : ''}>PASS</option>
                            <option value="fail" ${data.status === 'fail' ? 'selected' : ''}>FAIL</option>
                            <option value="na" ${data.status === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(equipmentDiv);
            updateSectionStatusAfterChange();
        }

        function addController(data = {}) {
            controllerCounter++;
            const container = document.getElementById('controllers-container');
            
            // Find the selected controller data if it exists
            let selectedController = null;
            if (data.node_id) {
                selectedController = availableControllers.find(c => c.id == data.node_id);
                if (!selectedController) {
                    // If controller not in available list, create a placeholder
                    selectedController = {
                        id: data.node_id,
                        node_name: data.node_name || 'Assigned Controller',
                        node_type: data.node_type || 'Controller',
                        model: data.model || 'Unknown Model',
                        serial: data.serial || 'No Serial',
                        firmware: data.firmware || 'Unknown'
                    };
                }
            }
            
            const controllerDiv = document.createElement('div');
            controllerDiv.className = 'component-card border border-gray-200 rounded-lg p-4 bg-gray-50';
            controllerDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-lg font-medium text-gray-900">Controller ${controllerCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeController(this)">üóëÔ∏è Remove</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="form-label">Controller</label>
                        <div class="flex gap-2">
                            <button type="button" class="btn btn-outline flex-1" onclick="openControllerModal(${controllerCounter})" id="controller-select-btn-${controllerCounter}">
                                ${selectedController ? `[${getEnhancedControllerType(selectedController)}] ${selectedController.node_name}` : 'Select Controller'}
                            </button>
                            ${selectedController ? `<button type="button" class="btn btn-outline btn-sm" onclick="clearController(${controllerCounter})">Clear</button>` : ''}
                        </div>
                        <input type="hidden" name="controllers[${controllerCounter}][node_id]" value="${data.node_id || ''}" id="controller-node-id-${controllerCounter}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="controllers[${controllerCounter}][status]" class="form-select">
                            <option value="pass" ${data.status === 'pass' || !data.status ? 'selected' : ''}>PASS</option>
                            <option value="fail" ${data.status === 'fail' ? 'selected' : ''}>FAIL</option>
                            <option value="na" ${data.status === 'na' ? 'selected' : ''}>N/A</option>
                        </select>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="form-label">Notes</label>
                        <textarea name="controllers[${controllerCounter}][notes]" class="form-input" rows="2" placeholder="Additional notes about this controller">${data.notes || ''}</textarea>
                    </div>
                </div>
                <div id="controller-info-${controllerCounter}" class="mt-3 p-3 bg-blue-50 rounded border" style="display: ${data.node_id ? 'block' : 'none'}">
                    <div class="text-sm text-gray-700">
                        <div><strong>Model:</strong> <span class="controller-model">${selectedController?.model || ''}</span></div>
                        <div><strong>Serial:</strong> <span class="controller-serial">${selectedController?.serial || ''}</span></div>
                        <div><strong>Firmware:</strong> <span class="controller-firmware">${selectedController?.firmware || ''}</span></div>
                    </div>
                </div>
            `;
            
            container.appendChild(controllerDiv);
            updateSectionStatusAfterChange();
        }

        async function removeController(button) {
            const component = button.closest('.component-card');
            if (component) {
                // Check if a controller was selected and unassign it
                const hiddenInput = component.querySelector('input[name*="node_id"]');
                const nodeId = hiddenInput ? hiddenInput.value : null;
                
                if (nodeId) {
                    try {
                        await fetch(`/api/nodes/${nodeId}/unassign`, {
                            method: 'POST'
                        });
                        console.log('DEBUG: Controller unassigned:', nodeId);
                    } catch (error) {
                        console.error('DEBUG: Error unassigning controller:', error);
                    }
                }
                
                component.remove();
                updateSectionStatusAfterChange();
                
                // Refresh available controllers for the modal
                await loadControllersWithStatus();
            }
        }

        function removeComponent(button) {
            const component = button.closest('.component-card');
            if (component) {
                component.remove();
                updateSectionStatusAfterChange();
                renumberComponents();
            }
        }

        function renumberComponents() {
            // Renumber power supplies
            const powerSupplies = document.querySelectorAll('#power-supplies-container .component-card');
            powerSupplyCounter = 0;
            powerSupplies.forEach((supply, index) => {
                const number = index + 1;
                const header = supply.querySelector('h4');
                if (header) {
                    header.textContent = `Power Supply ${number}`;
                }
                
                // Update all form field names
                supply.querySelectorAll('select, input').forEach(field => {
                    if (field.name && field.name.includes('power_supplies')) {
                        field.name = field.name.replace(/power_supplies\[\d+\]/, `power_supplies[${number}]`);
                    }
                });
                
                powerSupplyCounter = Math.max(powerSupplyCounter, number);
            });

            // Renumber distribution blocks
            const distributionBlocks = document.querySelectorAll('#distribution-blocks-container .component-card');
            distributionBlockCounter = 0;
            distributionBlocks.forEach((block, index) => {
                const number = index + 1;
                const header = block.querySelector('h4');
                if (header) {
                    header.textContent = `Distribution Block ${number}`;
                }
                
                // Update all form field names
                block.querySelectorAll('select, input').forEach(field => {
                    if (field.name && field.name.includes('distribution_blocks')) {
                        field.name = field.name.replace(/distribution_blocks\[\d+\]/, `distribution_blocks[${number}]`);
                    }
                });
                
                distributionBlockCounter = Math.max(distributionBlockCounter, number);
            });

            // Renumber diodes
            const diodes = document.querySelectorAll('#diodes-container .component-card');
            diodeCounter = 0;
            diodes.forEach((diode, index) => {
                const number = index + 1;
                const header = diode.querySelector('h4');
                if (header) {
                    header.textContent = `Diode ${number}`;
                }
                
                // Update all form field names
                diode.querySelectorAll('select, input').forEach(field => {
                    if (field.name && field.name.includes('diodes')) {
                        field.name = field.name.replace(/diodes\[\d+\]/, `diodes[${number}]`);
                    }
                });
                
                diodeCounter = Math.max(diodeCounter, number);
            });

            // Renumber network equipment
            const networkEquipment = document.querySelectorAll('#network-equipment-container .component-card');
            networkEquipmentCounter = 0;
            networkEquipment.forEach((equipment, index) => {
                const number = index + 1;
                const header = equipment.querySelector('h4');
                if (header) {
                    header.textContent = `Network Equipment ${number}`;
                }
                
                // Update all form field names
                equipment.querySelectorAll('select, input').forEach(field => {
                    if (field.name && field.name.includes('network_equipment')) {
                        field.name = field.name.replace(/network_equipment\[\d+\]/, `network_equipment[${number}]`);
                    }
                });
                
                networkEquipmentCounter = Math.max(networkEquipmentCounter, number);
            });

            // Renumber controllers
            const controllers = document.querySelectorAll('#controllers-container .component-card');
            controllerCounter = 0;
            controllers.forEach((controller, index) => {
                const number = index + 1;
                const header = controller.querySelector('h4');
                if (header) {
                    header.textContent = `Controller ${number}`;
                }
                
                // Update all form field names
                controller.querySelectorAll('select, input').forEach(field => {
                    if (field.name && field.name.includes('controllers')) {
                        field.name = field.name.replace(/controllers\[\d+\]/, `controllers[${number}]`);
                    }
                });
                
                controllerCounter = Math.max(controllerCounter, number);
            });
        }

        async function saveCabinet() {
            if (isSessionCompleted) {
                showMessage('Cannot save changes - PM session is completed', 'error');
                return;
            }
            
            console.log('DEBUG: Starting cabinet save');
            const formData = new FormData(document.getElementById('cabinet-form'));
            const data = {};
            
            // Convert FormData to structured object
            for (let [key, value] of formData.entries()) {
                console.log('DEBUG: FormData entry:', key, '=', value);
                if (key.includes('[')) {
                    // Handle array data like power_supplies[1][voltage_type]
                    const matches = key.match(/(\w+)\[(\d+)\]\[(\w+)\]/);
                    if (matches) {
                        const [, arrayName, index, property] = matches;
                        if (!data[arrayName]) data[arrayName] = [];
                        if (!data[arrayName][index]) data[arrayName][index] = {};
                        data[arrayName][index][property] = value;
                    }
                } else {
                    data[key] = value;
                }
            }
            
            console.log('DEBUG: Processed data before cleanup:', data);
            
            // Handle custom model numbers for network equipment
            if (data.network_equipment) {
                data.network_equipment.forEach(equipment => {
                    if (equipment.model_number === 'custom' && equipment.model_number_custom) {
                        equipment.model_number = equipment.model_number_custom;
                    }
                    delete equipment.model_number_custom;
                });
            }
            
            // Convert arrays to clean format
            ['power_supplies', 'distribution_blocks', 'diodes', 'network_equipment', 'controllers'].forEach(arrayName => {
                if (data[arrayName]) {
                    data[arrayName] = data[arrayName].filter(item => item !== null);
                }
            });
            
            // Separate inspection data
            const inspectionFields = ['cabinet_fans', 'controller_leds', 'io_status', 'network_status', 
                                    'temperatures', 'is_clean', 'clean_filter_installed', 'ground_inspection', 'comments'];
            data.inspection = {};
            inspectionFields.forEach(field => {
                if (data[field] !== undefined) {
                    data.inspection[field] = data[field];
                    delete data[field];
                }
            });

            console.log('DEBUG: Final data to save:', data);
            
            try {
                // First save the cabinet data
                const response = await fetch(`/api/cabinets/${currentCabinetId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('DEBUG: Save response:', result);

                if (result.success) {
                    // Only assign controllers AFTER successful cabinet save
                    console.log('DEBUG: Controllers to assign:', data.controllers);
                    if (data.controllers && data.controllers.length > 0) {
                        console.log('DEBUG: Processing controller assignments after successful save');
                        
                        let assignmentErrors = [];
                        for (const controller of data.controllers) {
                            if (controller.node_id) {
                                console.log('DEBUG: Assigning controller:', controller.node_id, 'to cabinet:', currentCabinetId);
                                try {
                                    const assignResponse = await fetch(`/api/nodes/${controller.node_id}/assign`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ cabinet_id: currentCabinetId })
                                    });
                                    
                                    if (!assignResponse.ok) {
                                        const assignResult = await assignResponse.json();
                                        assignmentErrors.push(`Controller ${controller.node_id}: ${assignResult.error}`);
                                    } else {
                                        console.log('DEBUG: Controller assignment successful');
                                    }
                                } catch (error) {
                                    console.error('DEBUG: Error assigning controller:', error);
                                    assignmentErrors.push(`Controller ${controller.node_id}: Network error`);
                                }
                            }
                        }
                        
                        if (assignmentErrors.length > 0) {
                            showMessage(`Cabinet saved, but some controller assignments failed: ${assignmentErrors.join(', ')}`, 'warning');
                        } else {
                            if (typeof playSuccessSound === 'function') {
                                playSuccessSound();
                            }
                            showMessage('Cabinet data saved successfully', 'success');
                        }
                    } else {
                        console.log('DEBUG: No controllers to assign');
                        if (typeof playSuccessSound === 'function') {
                            playSuccessSound();
                        }
                        showMessage('Cabinet data saved successfully', 'success');
                    }
                    
                    // Refresh available controllers after successful save
                    await loadAvailableControllers();
                } else {
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage(result.error || 'Error saving cabinet', 'error');
                }
            } catch (error) {
                console.error('DEBUG: Network error saving cabinet:', error);
                showMessage('Network error. Please try again.', 'error');
            }
        }

        async function saveToPDF() {
            // First save the current data
            await saveCabinet();
            
            // Then generate PDF
            try {
                showMessage('üîÑ Generating PDF... Please wait', 'info');
                const response = await fetch(`/api/cabinets/${currentCabinetId}/pdf`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `cabinet-pm-${cabinetData.cabinet_location}-${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage('‚úÖ PDF generated and compressed successfully!', 'success');
                } else {
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage('Error generating PDF', 'error');
                }
            } catch (error) {
                showMessage('Error generating PDF', 'error');
            }
        }

        function showMessage(text, type = 'info', duration = 5000) {
            const message = document.getElementById('message');
            
            // Clear any existing timeout
            if (message.timeout) {
                clearTimeout(message.timeout);
            }
            
            // Set message content with close button
            message.innerHTML = `
                ${text}
                <button class="message-close" onclick="hideMessage()">&times;</button>
            `;
            message.className = `message ${type}`;
            
            // Auto-hide after duration
            message.timeout = setTimeout(() => {
                hideMessage();
            }, duration);
        }

        function hideMessage() {
            const message = document.getElementById('message');
            message.textContent = '';
            message.className = 'message';
            if (message.timeout) {
                clearTimeout(message.timeout);
            }
        }

        function handleModelSelection(select) {
            const customInput = select.parentElement.querySelector('input[name*="model_number_custom"]');
            if (select.value === 'custom') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        // Voltage range validation
        const VOLTAGE_RANGES = {
            // DC voltage ranges
            '24VDC': { min: 22.8, max: 25.2 },
            '12VDC': { min: 11.4, max: 12.6 },
            // AC voltage ranges
            'line_neutral': { min: 100, max: 130, unit: 'V' },
            'line_ground': { min: 100, max: 130, unit: 'V' },
            'neutral_ground': { min: 0, max: 1000, unit: 'mV' }
        };

        function validateDCVoltage(input, voltageType) {
            const value = parseFloat(input.value);
            const range = VOLTAGE_RANGES[voltageType];
            
            // Remove any existing validation classes
            input.classList.remove('voltage-valid', 'voltage-invalid');
            
            if (input.value && !isNaN(value) && range) {
                if (value >= range.min && value <= range.max) {
                    input.classList.add('voltage-valid');
                    input.title = `‚úì Within range (${range.min}-${range.max}V)`;
                } else {
                    input.classList.add('voltage-invalid');
                    input.title = `‚ö† Outside range (${range.min}-${range.max}V)`;
                }
            } else {
                input.title = '';
            }
            
            // Update power supply status based on all voltage readings
            updatePowerSupplyStatus(input.closest('.component-card'));
        }

        function validateACVoltage(input, measurementType) {
            const value = parseFloat(input.value);
            const range = VOLTAGE_RANGES[measurementType];
            
            // Remove any existing validation classes
            input.classList.remove('voltage-valid', 'voltage-invalid');
            
            if (input.value && !isNaN(value) && range) {
                if (value >= range.min && value <= range.max) {
                    input.classList.add('voltage-valid');
                    input.title = `‚úì Within range (${range.min}-${range.max}${range.unit})`;
                } else {
                    input.classList.add('voltage-invalid');
                    input.title = `‚ö† Outside range (${range.min}-${range.max}${range.unit})`;
                }
            } else {
                input.title = '';
            }
            
            // Update power supply status based on all voltage readings
            updatePowerSupplyStatus(input.closest('.component-card'));
        }

        function updatePowerSupplyStatus(container) {
            const statusSelect = container.querySelector('select[name*="status"]');
            if (!statusSelect) return;
            
            // Don't auto-change if user has manually set to N/A
            if (statusSelect.value === 'na') return;
            
            // Clear any existing timeout for this container
            if (container.statusUpdateTimeout) {
                clearTimeout(container.statusUpdateTimeout);
            }
            
            // Add a small delay to allow user to finish typing
            container.statusUpdateTimeout = setTimeout(() => {
                evaluatePowerSupplyStatus(container);
            }, 1000); // Wait 1 second after user stops typing
        }
        
        function evaluatePowerSupplyStatus(container) {
            const statusSelect = container.querySelector('select[name*="status"]');
            if (!statusSelect || statusSelect.value === 'na') return;
            
            // Get all voltage inputs
            const dcInput = container.querySelector('input[name*="dc_reading"]');
            const lineNeutralInput = container.querySelector('input[name*="line_neutral"]');
            const lineGroundInput = container.querySelector('input[name*="line_ground"]');
            const neutralGroundInput = container.querySelector('input[name*="neutral_ground"]');
            
            // Check if any required fields have values
            const hasAnyValues = [dcInput, lineNeutralInput, lineGroundInput, neutralGroundInput]
                .some(input => input && input.value.trim() !== '');
            
            // If no values entered yet, don't change status
            if (!hasAnyValues) return;
            
            // Check if all voltage readings that have values are valid
            let allValid = true;
            let hasInvalidValues = false;
            let totalInputsWithValues = 0;
            let validInputsCount = 0;
            
            // Check each input that has a value
            [dcInput, lineNeutralInput, lineGroundInput, neutralGroundInput].forEach(input => {
                if (input && input.value.trim() !== '') {
                    totalInputsWithValues++;
                    if (input.classList.contains('voltage-invalid')) {
                        hasInvalidValues = true;
                        allValid = false;
                    } else if (input.classList.contains('voltage-valid')) {
                        validInputsCount++;
                    }
                }
            });
            
            // Auto-fail if ANY reading is out of range
            if (hasInvalidValues) {
                if (statusSelect.value !== 'fail') {
                    statusSelect.value = 'fail';
                    console.log('DEBUG: Auto-failed power supply - voltage readings out of range');
                }
            } 
            // Auto-pass only if we have at least 2 valid readings and no invalid ones
            else if (validInputsCount >= 2 && allValid && totalInputsWithValues >= 2) {
                if (statusSelect.value !== 'pass') {
                    statusSelect.value = 'pass';
                    console.log('DEBUG: Auto-passed power supply - sufficient valid voltage readings');
                }
            }
        }

        function validateAllPowerSupplyVoltages(container) {
            // Validate DC reading
            const dcInput = container.querySelector('input[name*="dc_reading"]');
            const voltageType = container.querySelector('select[name*="voltage_type"]').value;
            if (dcInput) {
                validateDCVoltage(dcInput, voltageType);
            }
            
            // Validate AC readings
            const lineNeutralInput = container.querySelector('input[name*="line_neutral"]');
            const lineGroundInput = container.querySelector('input[name*="line_ground"]');
            const neutralGroundInput = container.querySelector('input[name*="neutral_ground"]');
            
            if (lineNeutralInput) validateACVoltage(lineNeutralInput, 'line_neutral');
            if (lineGroundInput) validateACVoltage(lineGroundInput, 'line_ground');
            if (neutralGroundInput) validateACVoltage(neutralGroundInput, 'neutral_ground');
            
            // Note: updatePowerSupplyStatus is called by individual validation functions
        }

        function addVoltageValidation() {
            // Add validation to existing power supply containers
            document.querySelectorAll('.component-card').forEach(container => {
                // Skip if not a power supply container
                if (!container.querySelector('select[name*="voltage_type"]')) return;
                
                // Validate all voltage inputs in this container
                validateAllPowerSupplyVoltages(container);
            });
        }

        // Controller Modal System Variables
        let currentControllerSlot = null;
        let selectedControllerId = null;
        let controllerModalData = [];
        let currentControllerFilter = 'all';

        // Load controllers with usage status
        async function loadControllersWithStatus() {
            if (!currentCustomerId) return;
            
            try {
                const url = currentSessionId ? 
                    `/api/customers/${currentCustomerId}/available-controllers?sessionId=${currentSessionId}` :
                    `/api/customers/${currentCustomerId}/available-controllers`;
                const response = await fetch(url);
                if (response.ok) {
                    controllerModalData = await response.json();
                    console.log('DEBUG: Loaded controllers with status:', controllerModalData);
                }
            } catch (error) {
                console.error('Error loading controllers with status:', error);
            }
        }

        // Open controller selection modal
        function openControllerModal(controllerSlot) {
            currentControllerSlot = controllerSlot;
            selectedControllerId = null;
            
            // Load fresh controller data
            loadControllersWithStatus().then(() => {
                populateControllerModal();
                document.getElementById('controller-modal').style.display = 'block';
            });
        }

        // Close controller selection modal
        function closeControllerModal() {
            document.getElementById('controller-modal').style.display = 'none';
            currentControllerSlot = null;
            selectedControllerId = null;
        }

        // Helper function to get enhanced controller type with model mappings
        function getEnhancedControllerType(controller) {
            const model = (controller.model || '').toLowerCase();
            const nodeType = (controller.node_type || '').toLowerCase();
            const nodeName = (controller.node_name || '').toLowerCase();
            
            // Specific model mappings
            if (model.includes('ve4021')) {
                return 'RIO';
            }
            if (model.includes('se4101')) {
                return 'EIOC';
            }
            
            // EIOC detection
            if (nodeType.includes('eioc') || nodeName.includes('eioc') || model.includes('eioc')) {
                return 'EIOC';
            }
            
            // Use original node_type or fallback
            return controller.node_type || 'Controller';
        }

        // Populate controller modal with data
        function populateControllerModal() {
            const list = document.getElementById('controller-list');
            list.innerHTML = '';
            
            // Filter controllers based on current filter
            let filteredControllers = controllerModalData;
            if (currentControllerFilter === 'available') {
                filteredControllers = controllerModalData.filter(c => c.usage_status === 'available');
            } else if (currentControllerFilter === 'used') {
                filteredControllers = controllerModalData.filter(c => c.usage_status !== 'available');
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('controller-search').value.toLowerCase();
            if (searchTerm) {
                filteredControllers = filteredControllers.filter(c => 
                    c.node_name.toLowerCase().includes(searchTerm) ||
                    c.node_type.toLowerCase().includes(searchTerm) ||
                    (c.model && c.model.toLowerCase().includes(searchTerm)) ||
                    (c.serial && c.serial.toLowerCase().includes(searchTerm))
                );
            }
            
            // Create controller items
            filteredControllers.forEach(controller => {
                const item = document.createElement('div');
                item.className = 'p-3 border rounded cursor-pointer hover:bg-gray-50';
                item.onclick = () => selectControllerInModal(controller.id);
                
                const enhancedType = getEnhancedControllerType(controller);
                
                let statusBadge = '';
                let statusClass = '';
                if (controller.usage_status === 'available') {
                    statusBadge = '<span class="badge badge-success">Available</span>';
                    statusClass = '';
                } else if (controller.usage_status === 'used_in_session') {
                    statusBadge = '<span class="badge badge-warning">Used in Session</span>';
                    statusClass = 'opacity-60';
                } else if (controller.usage_status === 'used_elsewhere') {
                    statusBadge = `<span class="badge badge-info">Used in ${controller.session_name || 'Other Session'}</span>`;
                    statusClass = 'opacity-60';
                }
                
                item.innerHTML = `
                    <div class="flex justify-between items-start ${statusClass}">
                        <div class="flex-1">
                            <div class="font-medium">[${enhancedType}] ${controller.node_name}</div>
                            <div class="text-sm text-gray-600">
                                Model: ${controller.model || 'Unknown'} | 
                                Serial: ${controller.serial || 'No Serial'} | 
                                Firmware: ${controller.firmware || 'Unknown'}
                            </div>
                            ${controller.cabinet_location ? `<div class="text-sm text-gray-500">Currently in: ${controller.cabinet_location}</div>` : ''}
                        </div>
                        <div class="ml-4">
                            ${statusBadge}
                        </div>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            if (filteredControllers.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">No controllers found</div>';
            }
        }

        // Select controller in modal
        function selectControllerInModal(controllerId) {
            selectedControllerId = controllerId;
            
            // Update visual selection
            document.querySelectorAll('#controller-list > div').forEach(item => {
                item.classList.remove('bg-blue-50', 'border-blue-300');
            });
            
            event.currentTarget.classList.add('bg-blue-50', 'border-blue-300');
            
            // Enable select button
            document.getElementById('select-controller-btn').disabled = false;
        }

        // Confirm controller selection
        function selectController() {
            if (!selectedControllerId || !currentControllerSlot) return;
            
            const controller = controllerModalData.find(c => c.id === selectedControllerId);
            if (!controller) return;
            
            // Update the button text and hidden input
            const button = document.getElementById(`controller-select-btn-${currentControllerSlot}`);
            const hiddenInput = document.getElementById(`controller-node-id-${currentControllerSlot}`);
            const infoDiv = document.getElementById(`controller-info-${currentControllerSlot}`);
            
            const enhancedType = getEnhancedControllerType(controller);
            button.textContent = `[${enhancedType}] ${controller.node_name}`;
            hiddenInput.value = controller.id;
            
            // Update controller info display
            infoDiv.querySelector('.controller-model').textContent = controller.model || 'Unknown';
            infoDiv.querySelector('.controller-serial').textContent = controller.serial || 'No Serial';
            infoDiv.querySelector('.controller-firmware').textContent = controller.firmware || 'Unknown';
            infoDiv.style.display = 'block';
            
            // Add clear button if it doesn't exist
            if (!button.nextElementSibling || !button.nextElementSibling.textContent.includes('Clear')) {
                const clearBtn = document.createElement('button');
                clearBtn.type = 'button';
                clearBtn.className = 'btn btn-outline btn-sm';
                clearBtn.textContent = 'Clear';
                clearBtn.onclick = () => clearController(currentControllerSlot);
                button.parentNode.appendChild(clearBtn);
            }
            
            // Auto-save after selection
            clearTimeout(window.cabinetAutoSaveTimeout);
            window.cabinetAutoSaveTimeout = setTimeout(() => {
                saveCabinet();
            }, 1000);
            
            closeControllerModal();
        }

        // Clear controller selection
        function clearController(controllerSlot) {
            const button = document.getElementById(`controller-select-btn-${controllerSlot}`);
            const hiddenInput = document.getElementById(`controller-node-id-${controllerSlot}`);
            const infoDiv = document.getElementById(`controller-info-${controllerSlot}`);
            
            // Clear the selection
            button.textContent = 'Select Controller';
            hiddenInput.value = '';
            infoDiv.style.display = 'none';
            
            // Remove clear button
            const clearBtn = button.nextElementSibling;
            if (clearBtn && clearBtn.textContent.includes('Clear')) {
                clearBtn.remove();
            }
            
            // Auto-save after clearing
            clearTimeout(window.cabinetAutoSaveTimeout);
            window.cabinetAutoSaveTimeout = setTimeout(() => {
                saveCabinet();
            }, 1000);
        }

        // Filter controllers in modal
        function filterControllers() {
            populateControllerModal();
        }

        // Show controller category
        function showControllerCategory(category) {
            currentControllerFilter = category;
            
            // Update button states
            document.querySelectorAll('[onclick^="showControllerCategory"]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            event.target.classList.remove('btn-outline');
            event.target.classList.add('btn-primary');
            
            populateControllerModal();
        }

        // Controller Management Modal
        function openControllerManagement() {
            loadControllerUsage().then(() => {
                populateControllerManagement();
                document.getElementById('controller-management-modal').style.display = 'block';
            });
        }

        function closeControllerManagement() {
            document.getElementById('controller-management-modal').style.display = 'none';
        }

        async function loadControllerUsage() {
            if (!currentCustomerId) return;
            
            try {
                const response = await fetch(`/api/customers/${currentCustomerId}/controller-usage`);
                if (response.ok) {
                    controllerModalData = await response.json();
                }
            } catch (error) {
                console.error('Error loading controller usage:', error);
            }
        }

        function populateControllerManagement() {
            const list = document.getElementById('management-controller-list');
            list.innerHTML = '';
            
            // Apply search filter
            const searchTerm = document.getElementById('management-search').value.toLowerCase();
            let filteredControllers = controllerModalData;
            if (searchTerm) {
                filteredControllers = controllerModalData.filter(c => 
                    c.node_name.toLowerCase().includes(searchTerm) ||
                    c.node_type.toLowerCase().includes(searchTerm) ||
                    (c.model && c.model.toLowerCase().includes(searchTerm)) ||
                    (c.serial && c.serial.toLowerCase().includes(searchTerm)) ||
                    (c.cabinet_location && c.cabinet_location.toLowerCase().includes(searchTerm))
                );
            }
            
            // Group by availability
            const available = filteredControllers.filter(c => !c.assigned_cabinet_id);
            const used = filteredControllers.filter(c => c.assigned_cabinet_id);
            
            // Create sections
            if (available.length > 0) {
                const availableSection = document.createElement('div');
                availableSection.innerHTML = `
                    <h4 class="text-lg font-medium text-green-600 mb-3">Available Controllers (${available.length})</h4>
                    <div class="space-y-2 mb-6">
                        ${available.map(controller => createControllerManagementItem(controller)).join('')}
                    </div>
                `;
                list.appendChild(availableSection);
            }
            
            if (used.length > 0) {
                const usedSection = document.createElement('div');
                usedSection.innerHTML = `
                    <h4 class="text-lg font-medium text-red-600 mb-3">Used Controllers (${used.length})</h4>
                    <div class="space-y-2">
                        ${used.map(controller => createControllerManagementItem(controller)).join('')}
                    </div>
                `;
                list.appendChild(usedSection);
            }
        }

        function createControllerManagementItem(controller) {
            const isUsed = controller.assigned_cabinet_id;
            const statusBadge = isUsed ? 
                `<span class="badge badge-warning">Used in ${controller.cabinet_location || 'Unknown Location'}</span>` :
                `<span class="badge badge-success">Available</span>`;
            
            const enhancedType = getEnhancedControllerType(controller);
            
            return `
                <div class="p-3 border rounded bg-white">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="font-medium">[${enhancedType}] ${controller.node_name}</div>
                            <div class="text-sm text-gray-600">
                                Model: ${controller.model || 'Unknown'} | 
                                Serial: ${controller.serial || 'No Serial'} | 
                                Firmware: ${controller.firmware || 'Unknown'}
                            </div>
                            ${isUsed ? `
                                <div class="text-sm text-gray-500">
                                    Used in: ${controller.cabinet_location} (${controller.session_name || 'Unknown Session'})
                                    ${controller.assigned_at ? `| Assigned: ${new Date(controller.assigned_at).toLocaleDateString()}` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="ml-4 flex items-center gap-2">
                            ${statusBadge}
                            ${isUsed ? `<button class="btn btn-sm btn-outline" onclick="unassignController(${controller.id})">Unassign</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        async function unassignController(controllerId) {
            if (!confirm('Are you sure you want to unassign this controller?')) return;
            
            try {
                const response = await fetch(`/api/nodes/${controllerId}/unassign`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showMessage('Controller unassigned successfully', 'success');
                    // Refresh the management modal
                    loadControllerUsage().then(() => {
                        populateControllerManagement();
                    });
                    // Also refresh the main controller data
                    loadControllersWithStatus();
                } else {
                    showMessage('Error unassigning controller', 'error');
                }
            } catch (error) {
                console.error('Error unassigning controller:', error);
                showMessage('Error unassigning controller', 'error');
            }
        }

        function filterManagementControllers() {
            populateControllerManagement();
        }
    </script>
</body>
</html> 
