<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet PM App - Customer Detail</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="/theme-system.js"></script>
    <script src="/sound-system.js"></script>
    <style>
        /* Fix parent container overflow issues */
        .overflow-x-auto {
            overflow: visible !important;
            position: relative;
            z-index: auto;
        }
        
        /* Ensure table elements don't clip dropdowns */
        table, tbody, tr, td {
            overflow: visible !important;
            position: relative;
            z-index: auto;
        }
        
        /* Ensure card bodies don't clip dropdown content */
        .card-body {
            overflow: visible !important;
        }
        
        /* Additional fixes for dropdown visibility */
        .action-safe-zone {
            overflow: visible !important;
            position: relative !important;
        }
        
        /* Prevent table row expansion when dropdown opens */
        td.relative {
            vertical-align: top;
            height: auto;
            position: relative;
        }
        
        td.relative > div {
            min-height: 0;
            position: relative;
        }
        
        .btn-group {
            position: relative;
            display: inline-block;
            z-index: 999998 !important;
            vertical-align: top;
        }
        
        .btn-group .dropdown-toggle {
            position: relative;
            vertical-align: top;
        }
        
        .dropdown-menu {
            display: none;
            position: fixed;
            min-width: 160px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            padding: 4px 0;
            white-space: nowrap;
            pointer-events: auto;
            z-index: 999999 !important;
            /* Ensure it's completely removed from document flow */
            transform: translateZ(0);
            will-change: transform;
        }

        .dropdown-menu.show {
            display: block !important;
            z-index: 999999 !important;
            position: fixed !important;
        }
        
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 16px;
            background: none;
            border: none;
            text-align: left;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        
        .dropdown-item:hover {
            background-color: #f3f4f6;
        }
        
        .dropdown-item.text-danger {
            color: #dc2626;
        }
        
        .dropdown-item.text-danger:hover {
            background-color: #fef2f2;
        }
        
        .dropdown-divider {
            height: 1px;
            margin: 4px 0;
            background-color: #e5e7eb;
            border: none;
        }
        
        .dropdown-toggle::after {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Professional Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-content">
            <a href="/dashboard.html" class="nav-brand">ECI Cabinet PM</a>
            <div class="nav-links">
                <a href="/dashboard.html">Dashboard</a>
                <a href="/pages/customers.html">Customers</a>
                <a href="/pages/sessions.html">PM Sessions</a>
                <span id="customer-name-nav" class="text-gray-600 text-sm"></span>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <header class="page-header">
            <div class="flex justify-between items-center">
                <div>
                    <h1 id="customer-title" class="text-3xl font-bold text-gray-900 mb-2">Customer Detail</h1>
                    <p id="customer-info" class="text-gray-600">Customer information and management</p>
                </div>
                <div class="flex gap-3">
                    <button id="back-to-customers" class="btn btn-secondary">‚Üê Back to Customers</button>
                    <button id="edit-customer-btn" class="btn btn-primary">‚öôÔ∏è Edit Customer</button>
                </div>
            </div>
        </header>

        <main>
            <!-- Customer Info Card -->
            <div class="card mb-6">
                <div class="card-header">
                    <h2 class="text-xl font-semibold text-gray-900">Customer Information</h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h3 class="font-medium text-gray-900 mb-2">Contact Details</h3>
                            <p class="text-sm text-gray-600 mb-1">
                                <strong>Location:</strong> <span id="customer-location">Loading...</span>
                            </p>
                            <p class="text-sm text-gray-600">
                                <strong>Contact:</strong> <span id="customer-contact">Loading...</span>
                            </p>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900 mb-2">Statistics</h3>
                            <p class="text-sm text-gray-600 mb-1">
                                <strong>Total Sessions:</strong> <span id="total-sessions">0</span>
                            </p>
                            <p class="text-sm text-gray-600">
                                <strong>Active Sessions:</strong> <span id="active-sessions">0</span>
                            </p>
                        </div>
                        <div>
                            <h3 class="font-medium text-gray-900 mb-2">Nodes</h3>
                            <p class="text-sm text-gray-600 mb-1">
                                <strong>Total Nodes:</strong> <span id="total-nodes">0</span>
                            </p>
                            <p class="text-sm text-gray-600">
                                <strong>Last Import:</strong> <span id="last-import">Never</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Import Nodes Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold text-gray-900">üìÅ Node Management</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-sm text-gray-600 mb-4">
                            Import and manage DeltaV network nodes for this customer.
                        </p>
                        <div class="flex gap-3 flex-wrap">
                            <button id="import-nodes-btn" class="btn btn-success">
                                üì§ Import Nodes from CSV
                            </button>
                            <button id="view-nodes-btn" class="btn btn-secondary">
                                üëÅÔ∏è View Nodes
                            </button>
                            <button id="delete-all-nodes-btn" class="btn btn-danger">
                                üóëÔ∏è Delete All Nodes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sessions Card -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-lg font-semibold text-gray-900">üìã PM Sessions</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-sm text-gray-600 mb-4">
                            Create and manage preventive maintenance and installation & integration sessions.
                        </p>
                        <div class="flex gap-3">
                            <button id="new-pm-session-btn" class="btn btn-primary">
                                ‚ûï New PM Session
                            </button>
                            <button id="new-ii-session-btn" class="btn btn-secondary">
                                üîß New I&I Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Sessions -->
            <div class="card">
                <div class="card-header">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Sessions</h2>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Active Sessions Table -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Active Sessions</h4>
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table">
                                <thead>
                                    <tr>
                                        <th>Session Name</th>
                                        <th>Type</th>
                                        <th>Created</th>
                                        <th>Status</th>
                                        <th>Cabinets</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="active-sessions-table">
                                    <!-- Active sessions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-active-sessions" class="no-data hidden">
                            <div class="text-4xl mb-2">üìã</div>
                            <p>No active PM sessions found.</p>
                        </div>
                        <!-- Active Sessions Pagination -->
                        <div id="active-sessions-pagination" class="pagination-container hidden">
                            <button id="active-prev-btn" class="btn btn-sm btn-secondary" disabled>‚Üê Previous</button>
                            <span id="active-page-info" class="pagination-info"></span>
                            <button id="active-next-btn" class="btn btn-sm btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>

                    <!-- Completed Sessions Table -->
                    <div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-4">Completed Sessions</h4>
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table">
                                <thead>
                                    <tr>
                                        <th>Session Name</th>
                                        <th>Type</th>
                                        <th>Created</th>
                                        <th>Completed</th>
                                        <th>Cabinets</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="completed-sessions-table">
                                    <!-- Completed sessions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-completed-sessions" class="no-data hidden">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <p>No completed PM sessions found.</p>
                        </div>
                        <!-- Completed Sessions Pagination -->
                        <div id="completed-sessions-pagination" class="pagination-container hidden">
                            <button id="completed-prev-btn" class="btn btn-sm btn-secondary" disabled>‚Üê Previous</button>
                            <span id="completed-page-info" class="pagination-info"></span>
                            <button id="completed-next-btn" class="btn btn-sm btn-secondary">Next ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Import Nodes Modal -->
    <div id="import-nodes-modal" class="modal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Import Nodes - <span id="import-customer-name"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2">
                        Upload a CSV file with your DeltaV network nodes. This will replace any existing nodes for this customer.
                    </p>
                    <div class="form-group">
                        <label for="nodes-file" class="form-label">Select CSV File *</label>
                        <input type="file" id="nodes-file" accept=".csv" class="form-input" required>
                    </div>
                </div>
                
                <div id="preview-section" class="hidden">
                    <h4 class="text-md font-semibold mb-2">Preview (First 5 rows):</h4>
                    <div class="border rounded p-3 bg-gray-50 max-h-60 overflow-auto">
                        <pre id="preview-content" class="text-xs text-gray-700 whitespace-pre-wrap break-all"></pre>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <span id="preview-stats"></span>
                    </div>
                </div>

                <!-- Import Progress Section -->
                <div id="import-progress-section" class="hidden">
                    <div class="mb-3">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span id="progress-text">Importing nodes...</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 progress-container">
                            <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300 ease-out progress-bar-animated" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="inline-flex items-center text-sm text-gray-600">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="import-status">Processing your CSV file...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('import-nodes-modal')">Cancel</button>
                <button type="button" id="preview-nodes-btn" class="btn btn-info" disabled>Preview</button>
                <button type="button" id="import-nodes-confirm-btn" class="btn btn-success" disabled>Import Nodes</button>
            </div>
        </div>
    </div>

    <!-- View Nodes Modal -->
    <div id="view-nodes-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Equipment Overview - <span id="view-nodes-customer-name"></span></h3>
                <span class="close" onclick="closeModal('view-nodes-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <input type="text" id="nodes-search" class="form-input" placeholder="üîç Search equipment..." style="max-width: 400px;">
                </div>
                
                <!-- Controllers Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="card-title">üéõÔ∏è Controllers</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table-compact">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Controller Name</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Type</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Serial</th>
                                        <th class="px-3 py-2 text-center text-sm font-medium text-gray-900">Redundancy</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="controllers-nodes-table-body">
                                    <!-- Controllers will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CIOC Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="card-title">üîå CHARM I/O Cards (CIOC)</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table-compact">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">CIOC Name</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Type</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Serial</th>
                                        <th class="px-3 py-2 text-center text-sm font-medium text-gray-900">Redundancy</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="cioc-nodes-table-body">
                                    <!-- CIOC devices will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SIS Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="card-title">üõ°Ô∏è Safety Instrumented Systems (SIS)</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table-compact">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">SIS Device Name</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Type</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Serial</th>
                                        <th class="px-3 py-2 text-center text-sm font-medium text-gray-900">Redundancy</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="sis-nodes-table-body">
                                    <!-- SIS devices will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Workstations Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="card-title">üíª Workstations & Computers</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table-compact">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Computer Name</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Type</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Service Tag</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">OS</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="workstations-nodes-table-body">
                                    <!-- Workstations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Switches Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="card-title">üîå Network Switches</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="overflow-visible relative z-10">
                            <table class="w-full table-compact">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Switch Name</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Type</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Model</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Description</th>
                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-900">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="switches-nodes-table-body">
                                    <!-- Switches will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="no-equipment-found" class="text-center py-8 hidden">
                    <div class="text-4xl mb-2">üìã</div>
                    <p class="text-gray-600">No equipment found.</p>
                    <p class="text-sm text-gray-500">Try adjusting your search or import nodes first.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('view-nodes-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- New Session Modal -->
    <div id="new-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Session - <span id="new-session-customer-name"></span></h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="new-session-form">
                    <div class="form-group">
                        <label for="session-type" class="form-label">Session Type *</label>
                        <select id="session-type" class="form-input" required>
                            <option value="">Select session type...</option>
                            <option value="pm">PM - Preventive Maintenance</option>
                            <option value="ii">I&I - Installation & Integration</option>
                        </select>
                        <small class="text-gray-500">Choose the type of session to create</small>
                    </div>
                    <div class="form-group">
                        <label for="session-date" class="form-label">Session Date *</label>
                        <input type="date" id="session-date" class="form-input" required>
                        <small class="text-gray-500">Select the date when the session will be performed</small>
                    </div>
                    <div class="form-group">
                        <label for="session-custom-name" class="form-label">Session Name *</label>
                        <input type="text" id="session-custom-name" class="form-input" required
                               placeholder="Enter session name (e.g., Harmon Creek, Building A, etc.)">
                        <small class="text-gray-500">Enter a descriptive name for this PM session</small>
                    </div>
                    <div class="form-group">
                        <label for="session-name" class="form-label">Generated Full Session Name</label>
                        <input type="text" id="session-name" name="session_name" class="form-input" readonly 
                               placeholder="Full session name will be generated automatically">
                        <small class="text-gray-500">This will be your session name + date (e.g., "Harmon Creek - 9/10/2025")</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('new-session-modal')">Cancel</button>
                <button type="submit" form="new-session-form" class="btn btn-primary">Create Session</button>
            </div>
        </div>
    </div>

    <!-- Edit Session Modal -->
    <div id="edit-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Session</h3>
                <span class="close" onclick="closeModal('edit-session-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-session-form">
                    <div class="form-group">
                        <label for="edit-session-name" class="form-label">Session Name</label>
                        <input type="text" id="edit-session-name" name="session_name" required class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-session-status" class="form-label">Status</label>
                        <select id="edit-session-status" name="status" class="form-input">
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteSession()">Delete Session</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('edit-session-modal')">Cancel</button>
                <button type="submit" form="edit-session-form" class="btn btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Session Modal -->
    <div id="duplicate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Duplicate Session</h3>
                <span class="close" onclick="closeModal('duplicate-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="duplicate-form">
                    <div class="form-group">
                        <label for="duplicate-date" class="form-label">Session Date *</label>
                        <input type="date" id="duplicate-date" class="form-input" required>
                        <small class="text-gray-500">Select the date for this duplicated PM session</small>
                    </div>
                    <div class="form-group">
                        <label for="duplicate-name" class="form-label">Generated Session Name</label>
                        <input type="text" id="duplicate-name" name="session_name" class="form-input" readonly
                               placeholder="PM-MM/DD/YYYY">
                        <small class="text-gray-500">Session name will be automatically generated from the selected date</small>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-sm font-medium text-blue-900 mb-2">What will be duplicated:</h4>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li>‚Ä¢ Session structure and settings</li>
                            <li>‚Ä¢ Cabinet locations and configurations</li>
                            <li>‚Ä¢ Component layouts (data will be reset)</li>
                            <li>‚Ä¢ Equipment maintenance checklist (unchecked)</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('duplicate-modal')">Cancel</button>
                <button type="submit" form="duplicate-form" class="btn btn-success">Create Duplicate</button>
            </div>
        </div>
    </div>

    <!-- Bulk Import Cabinets Modal -->
    <div id="bulk-import-cabinets-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>üì§ Bulk Import Cabinets</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-4">
                        Upload a CSV file to import multiple cabinets at once. You must first select an existing PM session.
                    </p>
                    
                    <div class="form-group">
                        <label for="cabinet-session-select" class="form-label">Select PM Session *</label>
                        <select id="cabinet-session-select" class="form-select" required>
                            <option value="">Choose a session...</option>
                        </select>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <h4 class="font-medium text-blue-900 mb-2">Required CSV Format:</h4>
                        <code class="text-sm text-blue-800">cabinet_location,cabinet_date</code>
                        <p class="text-xs text-blue-700 mt-2">
                            <strong>Example:</strong><br>
                            Cabinet A-101,2024-01-15<br>
                            Cabinet B-205,2024-01-15<br>
                            Control Room Main,2024-01-16
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="cabinets-file" class="form-label">Select CSV File *</label>
                        <input type="file" id="cabinets-file" accept=".csv" class="form-input" required>
                    </div>
                </div>
                
                <div id="cabinets-preview-section" class="hidden">
                    <h4 class="text-md font-semibold mb-2">Preview (First 5 rows):</h4>
                    <div class="border rounded p-3 bg-gray-50 max-h-60 overflow-auto">
                        <pre id="cabinets-preview-content" class="text-xs text-gray-700 whitespace-pre-wrap break-all"></pre>
                    </div>
                    <div class="mt-2 text-sm text-gray-600">
                        <span id="cabinets-preview-stats"></span>
                    </div>
                </div>

                <!-- Import Progress Section -->
                <div id="cabinets-import-progress-section" class="hidden">
                    <div class="mb-3">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span id="cabinets-progress-text">Importing cabinets...</span>
                            <span id="cabinets-progress-percentage">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 progress-container">
                            <div id="cabinets-progress-bar" class="bg-green-600 h-3 rounded-full transition-all duration-300 ease-out progress-bar-animated" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="inline-flex items-center text-sm text-gray-600">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span id="cabinets-import-status">Processing your CSV file...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('bulk-import-cabinets-modal')">Cancel</button>
                <button type="button" id="preview-cabinets-btn" class="btn btn-info" disabled>Preview</button>
                <button type="button" id="import-cabinets-confirm-btn" class="btn btn-success" disabled>Import Cabinets</button>
            </div>
        </div>
    </div>

    <div id="message" class="message"></div>

    <script>
        let currentCustomer = null;
        let customerSessions = [];
        let customerNodes = [];
        let parsedNodes = [];

        // Session management variables
        let currentEditingSession = null;
        let currentDuplicatingSession = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get customer ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const customerId = urlParams.get('customer');
            
            if (!customerId) {
                window.location.href = '/pages/customers.html';
                return;
            }
            
            loadCustomerDetail(customerId);
            setupEventListeners();
            
            // Add global click debugging
            document.addEventListener('click', function(e) {
                console.log('DEBUG: Global click event detected on element:', e.target);
                console.log('DEBUG: Element classes:', e.target.className);
                console.log('DEBUG: Element onclick:', e.target.onclick);
                console.log('DEBUG: Event bubbling path:', e.composedPath());
            });
        });

        function setupEventListeners() {
            // Navigation
            document.getElementById('back-to-customers').addEventListener('click', () => {
                window.location.href = '/pages/customers.html';
            });
            
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Customer actions
            document.getElementById('edit-customer-btn').addEventListener('click', () => {
                window.location.href = `/customers.html?edit=${currentCustomer.id}`;
            });
            
            // Node management
            document.getElementById('import-nodes-btn').addEventListener('click', openImportNodesModal);
            document.getElementById('view-nodes-btn').addEventListener('click', openViewNodesModal);
            document.getElementById('delete-all-nodes-btn').addEventListener('click', deleteAllNodes);
            
            // Session management
            document.getElementById('new-pm-session-btn').addEventListener('click', () => createNewSession('pm'));
            document.getElementById('new-ii-session-btn').addEventListener('click', () => createNewSession('ii'));

            
            // Bulk import cabinets
            document.getElementById('cabinets-file').addEventListener('change', handleCabinetsFileSelect);
            document.getElementById('preview-cabinets-btn').addEventListener('click', previewCabinets);
            document.getElementById('import-cabinets-confirm-btn').addEventListener('click', importCabinets);

            
            // New session form
            document.getElementById('new-session-form').addEventListener('submit', handleCreateSession);
            
            // Session date auto-formatting
            document.getElementById('session-date').addEventListener('change', updateSessionName);
            document.getElementById('session-custom-name').addEventListener('input', updateSessionName);
            document.getElementById('duplicate-date').addEventListener('change', updateDuplicateSessionName);
            
            // Session management forms
            document.getElementById('edit-session-form').addEventListener('submit', editSession);
            document.getElementById('duplicate-form').addEventListener('submit', createDuplicateSession);

            // Import functionality
            document.getElementById('nodes-file').addEventListener('change', handleFileSelection);
            document.getElementById('preview-nodes-btn').addEventListener('click', previewNodes);
            document.getElementById('import-nodes-confirm-btn').addEventListener('click', confirmImportNodes);
            
            // View nodes functionality
            document.getElementById('nodes-search').addEventListener('input', filterViewNodes);

            // Modal close buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    closeModal(modal.id);
                });
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeModal(e.target.id);
                }
            });
        }

        async function loadCustomerDetail(customerId) {
            try {
                // Load customer info
                const customerResponse = await fetch(`/api/customers/${customerId}`);
                currentCustomer = await customerResponse.json();
                
                // Load customer sessions
                const sessionsResponse = await fetch(`/api/customers/${customerId}/sessions`);
                customerSessions = await sessionsResponse.json();
                
                // Load customer nodes
                try {
                    const nodesResponse = await fetch(`/api/customers/${customerId}/nodes`);
                    customerNodes = await nodesResponse.json();
                } catch (error) {
                    customerNodes = [];
                }
                
                updateUI();
                
            } catch (error) {
                showMessage('Error loading customer details', 'error');
                setTimeout(() => {
                    window.location.href = '/pages/customers.html';
                }, 2000);
            }
        }

        function updateUI() {
            // Update page title and info
            document.getElementById('customer-title').textContent = currentCustomer.name;
            document.getElementById('customer-info').textContent = `Customer details and management for ${currentCustomer.name}`;
            document.getElementById('customer-name-nav').textContent = currentCustomer.name;
            
            // Update customer info
            document.getElementById('customer-location').textContent = currentCustomer.location || 'Not specified';
            document.getElementById('customer-contact').textContent = currentCustomer.contact_info || 'Not specified';
            
            // Update statistics
            const activeSessions = customerSessions.filter(s => s.status !== 'completed').length;
            document.getElementById('total-sessions').textContent = customerSessions.length;
            document.getElementById('active-sessions').textContent = activeSessions;
            document.getElementById('total-nodes').textContent = customerNodes.length;
            
            // Update last import (this would need to be tracked in the future)
            document.getElementById('last-import').textContent = customerNodes.length > 0 ? 'Recently' : 'Never';
            
            // Load sessions tables
            loadSessionsTables();
        }

        // Pagination variables
        let activeSessionsPage = 1;
        let completedSessionsPage = 1;
        const sessionsPerPage = 5;

        function loadSessionsTables() {
            // Separate sessions into active and completed
            const activeSessions = customerSessions.filter(s => s.status !== 'completed');
            const completedSessions = customerSessions.filter(s => s.status === 'completed');
            
            // Sort by creation date (newest first)
            activeSessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            completedSessions.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Load active sessions
            loadActiveSessionsTable(activeSessions);
            
            // Load completed sessions  
            loadCompletedSessionsTable(completedSessions);
        }

        function loadActiveSessionsTable(sessions) {
            const tbody = document.getElementById('active-sessions-table');
            const noSessions = document.getElementById('no-active-sessions');
            const pagination = document.getElementById('active-sessions-pagination');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '';
                noSessions.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            noSessions.classList.add('hidden');
            
            // Calculate pagination
            const totalPages = Math.ceil(sessions.length / sessionsPerPage);
            const startIndex = (activeSessionsPage - 1) * sessionsPerPage;
            const endIndex = startIndex + sessionsPerPage;
            const currentSessions = sessions.slice(startIndex, endIndex);
            
            // Render sessions
            tbody.innerHTML = '';
            currentSessions.forEach(session => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const createdDate = new Date(session.created_at);
                const isRecent = (Date.now() - createdDate.getTime()) < (7 * 24 * 60 * 60 * 1000);
                
                row.innerHTML = `
                    <td class="px-4 py-3 cursor-pointer" onclick="console.log('DEBUG: Row cell clicked - Session ID:', '${session.id}', 'Session Name:', '${session.session_name}'); viewSession('${session.id}')">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-gray-900">${session.session_name}</span>
                            ${isRecent ? '<span class="badge bg-blue-100 text-blue-800 text-xs">New</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm cursor-pointer" onclick="console.log('DEBUG: Row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">
                        <span class="badge ${session.session_type === 'ii' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}">${session.session_type === 'ii' ? 'I&I' : 'PM'}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 cursor-pointer" onclick="console.log('DEBUG: Row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">${createdDate.toLocaleDateString('en-US')}</td>
                    <td class="px-4 py-3 cursor-pointer" onclick="console.log('DEBUG: Row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">
                        <span class="badge badge-${session.status || 'active'}">${(session.status || 'active').toUpperCase()}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 cursor-pointer" onclick="console.log('DEBUG: Row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">${session.cabinet_count || 0}</td>
                    <td class="relative z-20" style="overflow: visible !important;">
                        <div class="flex gap-1 justify-center">
                            <button class="btn btn-xs btn-primary" onclick="console.log('DEBUG: View button clicked - Session ID:', '${session.id}'); viewSession('${session.id}')" title="View Session">
                                View
                            </button>
                            <div class="relative inline-block">
                                <button class="btn btn-xs btn-secondary dropdown-toggle" onclick="toggleDropdown(this)" title="More Actions">Actions ‚ñº</button>
                                <div class="dropdown-menu absolute top-full right-0 z-50">
                                    <button class="dropdown-item" onclick="console.log('DEBUG: Edit button clicked - Session ID:', '${session.id}'); editSessionModal('${session.id}'); closeDropdown()">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="dropdown-item" onclick="console.log('DEBUG: Bulk import button clicked - Session ID:', '${session.id}'); openBulkImportForSession('${session.id}'); closeDropdown()">
                                        üì§ Bulk Import Cabinets
                                    </button>
                                    <button class="dropdown-item" onclick="console.log('DEBUG: Duplicate button clicked - Session ID:', '${session.id}'); duplicateSession('${session.id}'); closeDropdown()">
                                        üìã Duplicate
                                    </button>
                                    <button class="dropdown-item" onclick="console.log('DEBUG: Complete button clicked - Session ID:', '${session.id}', 'Session Name:', '${session.session_name}'); completeSession('${session.id}', '${session.session_name.replace(/'/g, "\\'")}'); closeDropdown()">
                                        ‚úì Complete
                                    </button>
                                    <hr class="dropdown-divider">
                                    <button class="dropdown-item text-danger" onclick="console.log('DEBUG: Delete button clicked - Session ID:', '${session.id}'); deleteSessionDirect('${session.id}'); closeDropdown()">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Handle pagination
            if (totalPages > 1) {
                pagination.classList.remove('hidden');
                document.getElementById('active-page-info').textContent = `Page ${activeSessionsPage} of ${totalPages}`;
                document.getElementById('active-prev-btn').disabled = activeSessionsPage === 1;
                document.getElementById('active-next-btn').disabled = activeSessionsPage === totalPages;
                
                // Add event listeners for pagination buttons
                document.getElementById('active-prev-btn').onclick = () => {
                    if (activeSessionsPage > 1) {
                        activeSessionsPage--;
                        loadActiveSessionsTable(sessions);
                    }
                };
                
                document.getElementById('active-next-btn').onclick = () => {
                    if (activeSessionsPage < totalPages) {
                        activeSessionsPage++;
                        loadActiveSessionsTable(sessions);
                    }
                };
            } else {
                pagination.classList.add('hidden');
            }
        }

        function loadCompletedSessionsTable(sessions) {
            const tbody = document.getElementById('completed-sessions-table');
            const noSessions = document.getElementById('no-completed-sessions');
            const pagination = document.getElementById('completed-sessions-pagination');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '';
                noSessions.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            noSessions.classList.add('hidden');
            
            // Calculate pagination
            const totalPages = Math.ceil(sessions.length / sessionsPerPage);
            const startIndex = (completedSessionsPage - 1) * sessionsPerPage;
            const endIndex = startIndex + sessionsPerPage;
            const currentSessions = sessions.slice(startIndex, endIndex);
            
            // Render sessions
            tbody.innerHTML = '';
            currentSessions.forEach(session => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const createdDate = new Date(session.created_at);
                const completedDate = session.completed_at ? new Date(session.completed_at) : null;
                
                row.innerHTML = `
                    <td class="px-4 py-3 cursor-pointer" onclick="console.log('DEBUG: Completed row cell clicked - Session ID:', '${session.id}', 'Session Name:', '${session.session_name}'); viewSession('${session.id}')">
                        <span class="font-medium text-gray-900">${session.session_name}</span>
                    </td>
                    <td class="px-4 py-3 text-sm cursor-pointer" onclick="console.log('DEBUG: Completed row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">
                        <span class="badge ${session.session_type === 'ii' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}">${session.session_type === 'ii' ? 'I&I' : 'PM'}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600 cursor-pointer" onclick="console.log('DEBUG: Completed row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">${createdDate.toLocaleDateString('en-US')}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 cursor-pointer" onclick="console.log('DEBUG: Completed row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">${completedDate ? completedDate.toLocaleDateString('en-US') : 'N/A'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600 cursor-pointer" onclick="console.log('DEBUG: Completed row cell clicked - Session ID:', '${session.id}'); viewSession('${session.id}')">${session.cabinet_count || 0}</td>
                    <td class="relative z-20" style="overflow: visible !important;">
                        <div class="flex gap-1 justify-center">
                            <button class="btn btn-xs btn-primary" onclick="console.log('DEBUG: Completed view button clicked - Session ID:', '${session.id}'); viewSession('${session.id}')" title="View Session">
                                View
                            </button>
                            <div class="relative inline-block">
                                <button class="btn btn-xs btn-secondary dropdown-toggle" onclick="toggleDropdown(this)" title="More Actions">Actions ‚ñº</button>
                                <div class="dropdown-menu absolute top-full right-0 z-50">
                                    <button class="dropdown-item" onclick="console.log('DEBUG: Completed duplicate button clicked - Session ID:', '${session.id}'); duplicateSession('${session.id}'); closeDropdown()">
                                        üìã Duplicate
                                    </button>
                                    <hr class="dropdown-divider">
                                    <button class="dropdown-item text-danger" onclick="console.log('DEBUG: Completed delete button clicked - Session ID:', '${session.id}'); deleteSessionDirect('${session.id}'); closeDropdown()">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Handle pagination
            if (totalPages > 1) {
                pagination.classList.remove('hidden');
                document.getElementById('completed-page-info').textContent = `Page ${completedSessionsPage} of ${totalPages}`;
                document.getElementById('completed-prev-btn').disabled = completedSessionsPage === 1;
                document.getElementById('completed-next-btn').disabled = completedSessionsPage === totalPages;
                
                // Add event listeners for pagination buttons
                document.getElementById('completed-prev-btn').onclick = () => {
                    if (completedSessionsPage > 1) {
                        completedSessionsPage--;
                        loadCompletedSessionsTable(sessions);
                    }
                };
                
                document.getElementById('completed-next-btn').onclick = () => {
                    if (completedSessionsPage < totalPages) {
                        completedSessionsPage++;
                        loadCompletedSessionsTable(sessions);
                    }
                };
            } else {
                pagination.classList.add('hidden');
            }
        }

        function viewSession(sessionId) {
            console.log('DEBUG: viewSession function called with sessionId:', sessionId);
            console.log('DEBUG: currentCustomer:', currentCustomer);
            console.log('DEBUG: Navigating to:', `/session.html?id=${sessionId}&customer=${currentCustomer.id}&customerName=${encodeURIComponent(currentCustomer.name)}`);
            window.location.href = `/session.html?id=${sessionId}&customer=${currentCustomer.id}&customerName=${encodeURIComponent(currentCustomer.name)}`;
        }

        async function completeSession(sessionId, sessionName) {
            console.log('DEBUG: completeSession function called with sessionId:', sessionId, 'sessionName:', sessionName);
            
            if (!confirm(`Are you sure you want to mark "${sessionName}" as completed? This action cannot be undone.`)) {
                console.log('DEBUG: User cancelled completion');
                return;
            }

            console.log('DEBUG: User confirmed completion, making API call to /api/sessions/' + sessionId + '/complete');

            try {
                const response = await fetch(`/api/sessions/${sessionId}/complete`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                console.log('DEBUG: API response status:', response.status);
                
                const result = await response.json();
                console.log('DEBUG: API response result:', result);

                if (result.success) {
                    console.log('DEBUG: Session completed successfully');
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage(`Session "${sessionName}" marked as completed`, 'success');
                    
                    // Reload customer sessions to update the tables
                    loadCustomerDetail(currentCustomer.id);
                } else {
                    console.log('DEBUG: Error completing session - result not successful:', result.error);
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage(result.error || 'Error completing session', 'error');
                }
            } catch (error) {
                console.log('DEBUG: Network error completing session - caught exception:', error);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Network error completing session', 'error');
                console.error('Complete session error:', error);
            }
        }

        function createNewSession(sessionType = '') {
            console.log('DEBUG: Creating new session for customer:', currentCustomer.name, 'Type:', sessionType);
            document.getElementById('new-session-customer-name').textContent = currentCustomer.name;
            
            // Clear previous values
            document.getElementById('session-type').value = sessionType;
            document.getElementById('session-date').value = '';
            document.getElementById('session-custom-name').value = '';
            document.getElementById('session-name').value = '';
            
            openModal('new-session-modal');
        }

        function updateSessionName() {
            const dateInput = document.getElementById('session-date');
            const customNameInput = document.getElementById('session-custom-name');
            const sessionNameInput = document.getElementById('session-name');
            
            const customName = customNameInput.value.trim();
            const dateValue = dateInput.value;
            
            if (customName && dateValue) {
                // Fix timezone issue by parsing date components directly
                const [year, month, day] = dateValue.split('-');
                const selectedDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                const formattedDate = selectedDate.toLocaleDateString('en-US'); // MM/DD/YYYY format
                sessionNameInput.value = `${customName} - ${formattedDate}`;
            } else if (customName) {
                sessionNameInput.value = `${customName} - [Select Date]`;
            } else if (dateValue) {
                // Fix timezone issue by parsing date components directly
                const [year, month, day] = dateValue.split('-');
                const selectedDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                const formattedDate = selectedDate.toLocaleDateString('en-US');
                sessionNameInput.value = `[Enter Name] - ${formattedDate}`;
            } else {
                sessionNameInput.value = '';
            }
        }

        function updateDuplicateSessionName() {
            const dateInput = document.getElementById('duplicate-date');
            const sessionNameInput = document.getElementById('duplicate-name');
            
            if (dateInput.value) {
                const selectedDate = new Date(dateInput.value);
                const formattedDate = selectedDate.toLocaleDateString('en-US'); // MM/DD/YYYY format
                sessionNameInput.value = `PM-${formattedDate}`;
            } else {
                sessionNameInput.value = '';
            }
        }

        // === DROPDOWN FUNCTIONS ===
        
        function toggleDropdown(button) {
            console.log('DEBUG: Toggling dropdown');
            if (event) event.stopPropagation();
            
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Toggle this dropdown
            const dropdown = button.nextElementSibling;
            console.log('DEBUG: Dropdown element found:', dropdown);
            
            if (!dropdown) {
                console.error('DEBUG: No dropdown menu found');
                return;
            }
            
            if (dropdown.classList.contains('show')) {
                console.log('DEBUG: Hiding dropdown');
                dropdown.classList.remove('show');
            } else {
                console.log('DEBUG: Showing dropdown');
                
                // Calculate position for fixed positioning
                const buttonRect = button.getBoundingClientRect();
                const dropdownHeight = 160; // Approximate dropdown height
                const viewportHeight = window.innerHeight;
                
                // Position below button, but if it would go off-screen, position above
                let top = buttonRect.bottom + window.scrollY;
                if (buttonRect.bottom + dropdownHeight > viewportHeight) {
                    top = buttonRect.top + window.scrollY - dropdownHeight;
                }
                
                dropdown.style.position = 'fixed';
                dropdown.style.top = buttonRect.bottom + 'px';
                dropdown.style.left = (buttonRect.right - 160) + 'px'; // Right-align with button
                dropdown.style.right = 'auto';
                
                dropdown.classList.add('show');
                console.log('DEBUG: Dropdown positioned and shown at', dropdown.style.top, dropdown.style.left);
            }
        }
        
        function closeDropdown() {
            console.log('DEBUG: Closing dropdown');
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-group')) {
                closeDropdown();
            }
        });
        
        // Close dropdowns on scroll and resize to prevent positioning issues
        window.addEventListener('scroll', closeDropdown);
        window.addEventListener('resize', closeDropdown);

        // === SESSION MANAGEMENT FUNCTIONS ===
        
        function editSessionModal(sessionId) {
            console.log('DEBUG: Opening edit modal for session ID:', sessionId);
            currentEditingSession = customerSessions.find(s => s.id === sessionId);
            if (!currentEditingSession) {
                console.error('DEBUG: Session not found:', sessionId);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Session not found', 'error');
                return;
            }
            
            console.log('DEBUG: Editing session:', currentEditingSession);
            document.getElementById('edit-session-name').value = currentEditingSession.session_name;
            document.getElementById('edit-session-status').value = currentEditingSession.status || 'active';
            
            openModal('edit-session-modal');
        }

        async function editSession(e) {
            e.preventDefault();
            console.log('DEBUG: Editing session form submitted');
            
            if (!currentEditingSession) {
                console.error('DEBUG: No session selected for editing');
                return;
            }
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            console.log('DEBUG: Edit session data:', data);

            try {
                const response = await fetch(`/api/sessions/${currentEditingSession.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('DEBUG: Edit session response:', result);

                if (result.success) {
                    closeModal('edit-session-modal');
                    loadCustomerDetail(currentCustomer.id);
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage('Session updated successfully', 'success');
                } else {
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage(result.error || 'Error updating session', 'error');
                }
            } catch (error) {
                console.error('DEBUG: Error updating session:', error);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Error updating session', 'error');
            }
        }

        async function deleteSession() {
            console.log('DEBUG: Delete session called for:', currentEditingSession);
            if (!currentEditingSession) return;
            
            if (!confirm(`Are you sure you want to delete "${currentEditingSession.session_name}"? This will also delete all associated cabinets and data.`)) {
                console.log('DEBUG: Delete cancelled by user');
                return;
            }

            try {
                const response = await fetch(`/api/sessions/${currentEditingSession.id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                console.log('DEBUG: Delete session response:', result);

                if (result.success) {
                    closeModal('edit-session-modal');
                    loadCustomerDetail(currentCustomer.id);
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage('Session deleted successfully', 'success');
                } else {
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage(result.error || 'Error deleting session', 'error');
                }
            } catch (error) {
                console.error('DEBUG: Error deleting session:', error);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Error deleting session', 'error');
            }
        }

        async function deleteSessionDirect(sessionId) {
            console.log('DEBUG: Direct delete session called for ID:', sessionId);
            const session = customerSessions.find(s => s.id === sessionId);
            if (!session) {
                console.error('DEBUG: Session not found:', sessionId);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Session not found', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete "${session.session_name}"? This will also delete all associated cabinets and data.`)) {
                console.log('DEBUG: Direct delete cancelled by user');
                return;
            }

            try {
                const response = await fetch(`/api/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                console.log('DEBUG: Direct delete response:', result);

                if (result.success) {
                    loadCustomerDetail(currentCustomer.id);
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage('Session deleted successfully', 'success');
                } else {
                    if (typeof playErrorSound === 'function') {
                        playErrorSound();
                    }
                    showMessage(result.error || 'Error deleting session', 'error');
                }
            } catch (error) {
                console.error('DEBUG: Error deleting session:', error);
                if (typeof playErrorSound === 'function') {
                    playErrorSound();
                }
                showMessage('Error deleting session', 'error');
            }
        }

        function duplicateSession(sessionId) {
            console.log('DEBUG: Duplicate session called for ID:', sessionId);
            currentDuplicatingSession = customerSessions.find(s => s.id === sessionId);
            if (!currentDuplicatingSession) {
                console.error('DEBUG: Session not found for duplication:', sessionId);
                showMessage('Session not found', 'error');
                return;
            }
            
            console.log('DEBUG: Duplicating session:', currentDuplicatingSession);
            // Pre-fill with today's date
            const today = new Date();
            const todayString = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
            document.getElementById('duplicate-date').value = todayString;
            
            // Auto-generate session name
            updateDuplicateSessionName();
            
            openModal('duplicate-modal');
        }

        async function createDuplicateSession(e) {
            e.preventDefault();
            console.log('DEBUG: Create duplicate session form submitted');
            
            if (!currentDuplicatingSession) {
                console.error('DEBUG: No session selected for duplication');
                return;
            }
            
            const formData = new FormData(e.target);
            const newSessionName = formData.get('session_name');
            console.log('DEBUG: New session name:', newSessionName);

            try {
                console.log('DEBUG: Using server-side duplicate endpoint');
                const response = await fetch(`/api/sessions/${currentDuplicatingSession.id}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_name: newSessionName
                    })
                });

                const result = await response.json();
                console.log('DEBUG: Server-side duplicate result:', result);
                
                if (result.success) {
                closeModal('duplicate-modal');
                loadCustomerDetail(currentCustomer.id);
                
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage(`Session "${newSessionName}" duplicated successfully`, 'success');
                } else {
                    throw new Error(result.error || 'Failed to duplicate session');
                }
                
            } catch (error) {
                console.error('DEBUG: Error duplicating session:', error);
                showMessage('Error duplicating session: ' + error.message, 'error');
            }
        }

        async function handleCreateSession(e) {
            e.preventDefault();
            
            const sessionType = document.getElementById('session-type').value;
            const sessionName = document.getElementById('session-name').value.trim();
            
            if (!sessionType) {
                showMessage('Please select a session type', 'error');
                return;
            }
            
            if (!sessionName) {
                showMessage('Please enter a session name', 'error');
                return;
            }

            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        customer_id: currentCustomer.id,
                        session_name: sessionName,
                        session_type: sessionType
                    })
                });

                const result = await response.json();

                if (result.success) {
                    closeModal('new-session-modal');
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                    showMessage(`Session "${sessionName}" created successfully`, 'success');
                    
                    // Reload customer sessions to show the new one
                    loadCustomerDetail(currentCustomer.id);
                } else {
                    showMessage(result.error || 'Error creating session', 'error');
                }
            } catch (error) {
                showMessage('Network error creating session', 'error');
                console.error('Create session error:', error);
            }
        }

        // === IMPORT NODES FUNCTIONALITY ===
        function openImportNodesModal() {
            document.getElementById('import-customer-name').textContent = currentCustomer.name;
            
            // Reset form
            document.getElementById('nodes-file').value = '';
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('import-progress-section').classList.add('hidden');
            document.getElementById('preview-nodes-btn').disabled = true;
            document.getElementById('import-nodes-confirm-btn').disabled = true;
            parsedNodes = [];
            
            // Reset progress bar color
            document.getElementById('progress-bar').className = 'bg-blue-600 h-3 rounded-full transition-all duration-300 ease-out progress-bar-animated';
            
            openModal('import-nodes-modal');
        }

        function handleFileSelection(e) {
            const file = e.target.files[0];
            if (file) {
                // Auto-parse the CSV file
                const reader = new FileReader();
                reader.onload = function(e) {
                    const csvText = e.target.result;
                    try {
                        parsedNodes = parseCSV(csvText);
                        
                        if (parsedNodes.length === 0) {
                            showMessage('No valid nodes found in CSV file', 'error');
                            document.getElementById('preview-nodes-btn').disabled = true;
                            document.getElementById('import-nodes-confirm-btn').disabled = true;
                            return;
                        }

                        // Show preview automatically
                        displayPreview(parsedNodes, csvText);
                        document.getElementById('preview-nodes-btn').disabled = false;
                        document.getElementById('import-nodes-confirm-btn').disabled = false;
                        
                    } catch (error) {
                        showMessage('Error parsing CSV: ' + error.message, 'error');
                        document.getElementById('preview-nodes-btn').disabled = true;
                        document.getElementById('import-nodes-confirm-btn').disabled = true;
                        parsedNodes = [];
                    }
                };
                reader.readAsText(file);
            } else {
                document.getElementById('preview-nodes-btn').disabled = true;
                document.getElementById('import-nodes-confirm-btn').disabled = true;
                document.getElementById('preview-section').classList.add('hidden');
                parsedNodes = [];
            }
        }

        function previewNodes() {
            const file = document.getElementById('nodes-file').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvText = e.target.result;
                try {
                    parsedNodes = parseCSV(csvText);
                    
                    if (parsedNodes.length === 0) {
                        showMessage('No valid nodes found in CSV file', 'error');
                        return;
                    }

                    // Show preview
                    displayPreview(parsedNodes, csvText);
                    document.getElementById('import-nodes-confirm-btn').disabled = false;
                    
                } catch (error) {
                    showMessage('Error parsing CSV: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) {
                throw new Error('CSV must have at least a header row and one data row');
            }

            const headers = lines[0].split(',').map(h => h.trim());
            const nodes = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                
                if (values.length < headers.length) continue;
                
                const node = {};
                let rawType = '';
                let isWindowsComputer = false;
                
                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    
                    switch (header) {
                        case 'Node Name':
                            node.node_name = value;
                            break;
                        case 'Type':
                            rawType = value;
                            // Map node types according to new requirements
                            if (value === 'CIOC') {
                                node.node_type = 'CIOC';
                            } else if (value === 'Charms Smart Logic Solver' || value === 'CSLS') {
                                node.node_type = 'SIS';
                            } else if (value === 'SZ Controller') {
                                node.node_type = 'SIS';
                            } else if (value === 'Controller') {
                                node.node_type = 'Controller';
                            } else if (value.includes('Operator') || value.includes('Application') || value.includes('Professional')) {
                                node.node_type = value; // Keep original for Windows computers
                                isWindowsComputer = true;
                            } else {
                            node.node_type = value;
                            }
                            break;
                        case 'Model':
                            // For Windows computers, use Serial as Service Tag instead of Model
                            if (!isWindowsComputer) {
                            node.model = value;
                            }
                            break;
                        case 'Description':
                            node.description = value;
                            // For controllers, store the full description in the model field for display
                            // This allows us to show "DeltaV SX Controller" instead of "SE3007"
                            if (value && (value.includes('Controller') || value.includes('Logic Solver') || value.includes('CHARM'))) {
                                node.model = value;
                            }
                            break;
                        case 'Serial':
                            if (isWindowsComputer) {
                                // For Windows computers, Serial becomes Service Tag (stored in model field)
                                node.model = value; // Service Tag
                                node.serial = value; // Keep original serial too
                            } else {
                            node.serial = value;
                            }
                            break;
                        case 'Firmware':
                            node.firmware = value;
                            break;
                        case 'Version':
                            node.version = value;
                            break;
                        case 'Status':
                            node.status = value;
                            break;
                        case 'Redundant':
                            node.redundant = value;
                            break;
                        case 'OS Name':
                            node.os_name = value;
                            break;
                        case 'OS Service Pack':
                            node.os_service_pack = value;
                            break;
                        case 'Bios Version':
                            node.bios_version = value;
                            break;
                        case 'OEM Type Description':
                            node.oem_type_description = value;
                            break;
                    }
                });
                
                // Update isWindowsComputer check after all headers are processed
                if (rawType.includes('Operator') || rawType.includes('Application') || rawType.includes('Professional')) {
                    isWindowsComputer = true;
                    // Re-process Serial field for Windows computers
                    const serialIndex = headers.indexOf('Serial');
                    if (serialIndex !== -1) {
                        const serialValue = values[serialIndex] || '';
                        node.model = serialValue; // Service Tag in model field
                        node.serial = serialValue; // Keep in serial field too
                    }
                }
                
                if (node.node_name && node.node_type) {
                    nodes.push(node);
                }
            }
            
            return nodes;
        }

        function displayPreview(nodes, csvText) {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            const previewStats = document.getElementById('preview-stats');
            
            const lines = csvText.split('\n').slice(0, 6).join('\n');
            previewContent.textContent = lines;
            
            const typeCount = {};
            nodes.forEach(node => {
                typeCount[node.node_type] = (typeCount[node.node_type] || 0) + 1;
            });
            
            const typeStats = Object.entries(typeCount)
                .map(([type, count]) => `${type}: ${count}`)
                .join(', ');
            
            previewStats.innerHTML = `
                <strong>Total nodes:</strong> ${nodes.length}<br>
                <strong>Types:</strong> ${typeStats}
            `;
            
            previewSection.classList.remove('hidden');
        }

        async function confirmImportNodes() {
            if (!currentCustomer || parsedNodes.length === 0) {
                showMessage('No data to import', 'error');
                return;
            }

            const warningMessage = customerNodes.length > 0 
                ? `‚ö†Ô∏è WARNING: This will COMPLETELY REPLACE all ${customerNodes.length} existing nodes for ${currentCustomer.name} with ${parsedNodes.length} new nodes.\n\nAny existing node assignments to cabinets will be cleared.\n\nContinue?`
                : `Import ${parsedNodes.length} nodes for ${currentCustomer.name}?`;

            if (!confirm(warningMessage)) {
                return;
            }

            try {
                startImportProgress();
                
                const response = await fetch(`/api/customers/${currentCustomer.id}/nodes/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nodes: parsedNodes, replace: true })
                });

                const result = await response.json();
                
                await completeImportProgress(result.success);

                if (result.success) {
                    closeModal('import-nodes-modal');
                    showMessage(
                        `Successfully replaced all nodes with ${result.imported} new nodes for ${currentCustomer.name}`, 
                        'success'
                    );
                    
                    // Reload customer data to update node count
                    loadCustomerDetail(currentCustomer.id);
                } else {
                    showMessage(result.error || 'Error importing nodes', 'error');
                }
            } catch (error) {
                await completeImportProgress(false);
                showMessage('Network error during import', 'error');
                console.error('Import error:', error);
            }
        }

        async function deleteAllNodes() {
            if (!currentCustomer) {
                showMessage('No customer selected', 'error');
                return;
            }

            if (customerNodes.length === 0) {
                showMessage('No nodes to delete', 'info');
                return;
            }

            const warningMessage = `‚ö†Ô∏è WARNING: This will permanently delete ALL ${customerNodes.length} nodes for ${currentCustomer.name}.\n\nAny node assignments to cabinets will be cleared.\n\nThis action cannot be undone. Are you sure?`;

            if (!confirm(warningMessage)) {
                return;
            }

            try {
                const response = await fetch(`/api/customers/${currentCustomer.id}/nodes`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    if (typeof playSuccessSound === 'function') {
                        playSuccessSound();
                    }
                showMessage(`Successfully deleted all ${result.deleted} nodes for ${currentCustomer.name}`, 'success');
                    
                    // Reload customer data to update node count
                    loadCustomerDetail(currentCustomer.id);
                } else {
                    showMessage(result.error || 'Error deleting nodes', 'error');
                }
            } catch (error) {
                showMessage('Network error during deletion', 'error');
                console.error('Delete nodes error:', error);
            }
        }

        function startImportProgress() {
            document.getElementById('preview-section').classList.add('hidden');
            document.getElementById('import-progress-section').classList.remove('hidden');
            
            document.getElementById('preview-nodes-btn').disabled = true;
            document.getElementById('import-nodes-confirm-btn').disabled = true;
            
            updateProgress(0, 'Preparing import...', 'Validating node data...');
            animateProgress();
        }

        function animateProgress() {
            const steps = [
                { percent: 20, text: 'Validating CSV data...', status: 'Checking node format and structure...' },
                { percent: 40, text: 'Connecting to database...', status: 'Establishing secure connection...' },
                { percent: 60, text: 'Processing nodes...', status: `Importing ${parsedNodes.length} nodes...` },
                { percent: 80, text: 'Updating database...', status: 'Saving node information...' },
                { percent: 95, text: 'Finalizing import...', status: 'Cleaning up and verifying data...' }
            ];
            
            let currentStep = 0;
            
            const progressInterval = setInterval(() => {
                if (currentStep < steps.length) {
                    const step = steps[currentStep];
                    updateProgress(step.percent, step.text, step.status);
                    currentStep++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 800);
            
            window.importProgressInterval = progressInterval;
        }

        function updateProgress(percent, text, status) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percentage').textContent = Math.round(percent) + '%';
            document.getElementById('progress-text').textContent = text;
            document.getElementById('import-status').textContent = status;
        }

        async function completeImportProgress(success) {
            if (window.importProgressInterval) {
                clearInterval(window.importProgressInterval);
            }
            
            if (success) {
                updateProgress(100, 'Import completed!', 'All nodes imported successfully');
                document.getElementById('progress-bar').className = 'bg-green-600 h-3 rounded-full transition-all duration-300 ease-out';
                document.getElementById('progress-text').className = 'import-step-complete';
            } else {
                updateProgress(100, 'Import failed', 'An error occurred during import');
                document.getElementById('progress-bar').className = 'bg-red-600 h-3 rounded-full transition-all duration-300 ease-out';
                document.getElementById('progress-text').className = 'import-step-error';
            }
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            resetImportModal();
        }

        function resetImportModal() {
            document.getElementById('import-progress-section').classList.add('hidden');
            document.getElementById('preview-nodes-btn').disabled = false;
            document.getElementById('import-nodes-confirm-btn').disabled = false;
            
            document.getElementById('progress-bar').className = 'bg-blue-600 h-3 rounded-full transition-all duration-300 ease-out progress-bar-animated';
            document.getElementById('progress-text').className = '';
        }

        // === VIEW NODES FUNCTIONALITY ===
        function openViewNodesModal() {
            document.getElementById('view-nodes-customer-name').textContent = currentCustomer.name;
            
            // Reset search
            document.getElementById('nodes-search').value = '';
            
            // Add search event listener
            document.getElementById('nodes-search').addEventListener('input', filterViewNodes);
            
            renderViewNodes(customerNodes);
            openModal('view-nodes-modal');
        }

        function filterViewNodes() {
            const searchTerm = document.getElementById('nodes-search').value.toLowerCase();
            
            const filtered = customerNodes.filter(node => {
                const matchesSearch = !searchTerm || 
                    node.node_name.toLowerCase().includes(searchTerm) ||
                    (node.model && node.model.toLowerCase().includes(searchTerm)) ||
                    (node.node_type && node.node_type.toLowerCase().includes(searchTerm));
                
                return matchesSearch;
            });
            
            renderViewNodes(filtered);
        }

        function renderViewNodes(nodes) {
            // Filter out partners and separate by type
            const filteredNodes = nodes.filter(node => !node.node_name.includes('-partner'));
            
            // Controllers: Include regular controllers + EIOC devices
            const controllers = filteredNodes.filter(node => 
                node.node_type === 'Controller' || 
                node.node_type === 'DeltaV EIOC' ||
                ['CP2-EIOC', 'CP3-EIOC', 'CP4-EIOC', 'UTIL-EIOC'].includes(node.node_name)
            );
            
            // CIOC: CHARM I/O Cards
            const ciocDevices = filteredNodes.filter(node => 
                node.node_type === 'CIOC'
            );
            
            // SIS: Safety Instrumented Systems (CSLS and SZ Controllers)
            const sisDevices = filteredNodes.filter(node => 
                node.node_type === 'SIS'
            );
            
            // Switches: Smart Network Devices and similar
            const switches = filteredNodes.filter(node => 
                node.node_type === 'Smart Network Devices' ||
                node.description === 'Smart Network Devices' ||
                node.node_name.includes('_DC_OP_') ||
                node.node_name.includes('_DC_SR_') ||
                node.node_name.includes('_CAB_')
            );
            
            // Workstations: Everything else except controllers, CIOC, SIS, switches, and excluded types
            const workstations = filteredNodes.filter(node => 
                !controllers.includes(node) &&
                !ciocDevices.includes(node) &&
                !sisDevices.includes(node) &&
                !switches.includes(node) &&
                !['Power Supply', 'Wireless Gateway'].includes(node.node_type)
            );
            
            renderControllersTable(controllers);
            renderCIOCTable(ciocDevices);
            renderSISTable(sisDevices);
            renderWorkstationsTable(workstations);
            renderSwitchesTable(switches);
            
            // Show/hide no data message
            const noDataDiv = document.getElementById('no-equipment-found');
            if (filteredNodes.length === 0) {
                noDataDiv.classList.remove('hidden');
            } else {
                noDataDiv.classList.add('hidden');
            }
        }

        function renderControllersTable(controllers) {
            const tbody = document.getElementById('controllers-nodes-table-body');
            tbody.innerHTML = '';
            
            if (controllers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No controllers found</td></tr>';
                return;
            }
            
            controllers.forEach(controller => {
                // Check for redundancy (if there's a partner controller)
                const hasRedundancy = customerNodes.some(node => 
                    node.node_name === controller.node_name + '-partner' || 
                    node.node_name === controller.node_name.replace('-primary', '-partner')
                );
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-medium text-sm">${controller.node_name}</td>
                    <td class="px-3 py-2 text-sm">${controller.description || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${controller.serial || 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        ${hasRedundancy ? 
                            '<span class="badge bg-green-100 text-green-800 text-xs">‚úì Redundant</span>' : 
                            '<span class="badge bg-gray-100 text-gray-800 text-xs">Single</span>'
                        }
                    </td>
                    <td class="px-3 py-2">
                        <span class="badge badge-${controller.status?.toLowerCase() || 'active'} text-xs">${controller.status || 'Active'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderCIOCTable(ciocDevices) {
            const tbody = document.getElementById('cioc-nodes-table-body');
            tbody.innerHTML = '';
            
            if (ciocDevices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No CIOC devices found</td></tr>';
                return;
            }
            
            ciocDevices.forEach(cioc => {
                // Check for redundancy (if there's a partner CIOC)
                const hasRedundancy = customerNodes.some(node => 
                    node.node_name === cioc.node_name + '-partner' || 
                    node.node_name === cioc.node_name.replace('-primary', '-partner')
                );
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-medium text-sm">${cioc.node_name}</td>
                    <td class="px-3 py-2 text-sm">${cioc.description || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${cioc.serial || 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        ${hasRedundancy ? 
                            '<span class="badge bg-green-100 text-green-800 text-xs">‚úì Redundant</span>' : 
                            '<span class="badge bg-gray-100 text-gray-800 text-xs">Single</span>'
                        }
                    </td>
                    <td class="px-3 py-2">
                        <span class="badge badge-${cioc.status?.toLowerCase() || 'active'} text-xs">${cioc.status || 'Active'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSISTable(sisDevices) {
            const tbody = document.getElementById('sis-nodes-table-body');
            tbody.innerHTML = '';
            
            if (sisDevices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No SIS devices found</td></tr>';
                return;
            }
            
            // Sort SIS devices: SZ Controllers first, then CSLS devices
            const sortedSisDevices = sisDevices.sort((a, b) => {
                // Check if device is SZ Controller (contains "SZ" in description or node name)
                const aIsSZ = a.description?.includes('SZ Controller') || a.node_name?.includes('-SZ');
                const bIsSZ = b.description?.includes('SZ Controller') || b.node_name?.includes('-SZ');
                
                if (aIsSZ && !bIsSZ) return -1; // a (SZ) comes first
                if (!aIsSZ && bIsSZ) return 1;  // b (SZ) comes first
                
                // If both are same type, sort alphabetically by node name
                return a.node_name.localeCompare(b.node_name);
            });
            
            sortedSisDevices.forEach(sis => {
                // Check for redundancy (if there's a partner SIS device)
                const hasRedundancy = customerNodes.some(node => 
                    node.node_name === sis.node_name + '-partner' || 
                    node.node_name === sis.node_name.replace('-primary', '-partner')
                );
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-medium text-sm">${sis.node_name}</td>
                    <td class="px-3 py-2 text-sm">${sis.description || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${sis.serial || 'N/A'}</td>
                    <td class="px-3 py-2 text-center">
                        ${hasRedundancy ? 
                            '<span class="badge bg-green-100 text-green-800 text-xs">‚úì Redundant</span>' : 
                            '<span class="badge bg-gray-100 text-gray-800 text-xs">Single</span>'
                        }
                    </td>
                    <td class="px-3 py-2">
                        <span class="badge badge-${sis.status?.toLowerCase() || 'active'} text-xs">${sis.status || 'Active'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderWorkstationsTable(workstations) {
            const tbody = document.getElementById('workstations-nodes-table-body');
            tbody.innerHTML = '';
            
            if (workstations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No workstations found</td></tr>';
                return;
            }
            
            workstations.forEach(workstation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-medium text-sm">${workstation.node_name}</td>
                    <td class="px-3 py-2 text-sm">${workstation.node_type || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${workstation.model || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${workstation.os_name || 'N/A'}</td>
                    <td class="px-3 py-2">
                        <span class="badge badge-${workstation.status?.toLowerCase() || 'active'} text-xs">${workstation.status || 'Active'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSwitchesTable(switches) {
            const tbody = document.getElementById('switches-nodes-table-body');
            tbody.innerHTML = '';
            
            if (switches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No switches found</td></tr>';
                return;
            }
            
            switches.forEach(switchNode => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-3 py-2 font-medium text-sm">${switchNode.node_name}</td>
                    <td class="px-3 py-2 text-sm">${switchNode.node_type || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${switchNode.model || 'N/A'}</td>
                    <td class="px-3 py-2 text-sm">${switchNode.description || 'N/A'}</td>
                    <td class="px-3 py-2">
                        <span class="badge badge-${switchNode.status?.toLowerCase() || 'active'} text-xs">${switchNode.status || 'Active'}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // === UTILITY FUNCTIONS ===
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showMessage(text, type = 'info', duration = 5000) {
            const message = document.getElementById('message');
            
            if (message.timeout) {
                clearTimeout(message.timeout);
            }
            
            message.innerHTML = `
                ${text}
                <button class="message-close" onclick="hideMessage()">&times;</button>
            `;
            message.className = `message ${type}`;
            
            message.timeout = setTimeout(() => {
                hideMessage();
            }, duration);
        }

        function hideMessage() {
            const message = document.getElementById('message');
            message.textContent = '';
            message.className = 'message';
            if (message.timeout) {
                clearTimeout(message.timeout);
            }
        }

        function logout() {
            localStorage.removeItem('sessionId');
            window.location.href = '/';
        }

        // Bulk Cabinet Import Functions
        let cabinetsFileData = null;

        function openBulkImportCabinetsModal() {
            // Populate session dropdown
            const sessionSelect = document.getElementById('cabinet-session-select');
            sessionSelect.innerHTML = '<option value="">Choose a session...</option>';
            
            const activeSessions = customerSessions.filter(s => s.status !== 'completed');
            activeSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = session.session_name;
                sessionSelect.appendChild(option);
            });
            
            if (activeSessions.length === 0) {
                showMessage('No active PM sessions found. Please create a session first.', 'warning');
                return;
            }
            
            openModal('bulk-import-cabinets-modal');
        }

        function openBulkImportForSession(sessionId) {
            // Populate session dropdown
            const sessionSelect = document.getElementById('cabinet-session-select');
            sessionSelect.innerHTML = '<option value="">Choose a session...</option>';
            
            const activeSessions = customerSessions.filter(s => s.status !== 'completed');
            activeSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                option.textContent = session.session_name;
                if (session.id === sessionId) {
                    option.selected = true;
                }
                sessionSelect.appendChild(option);
            });
            
            // Enable buttons if file is already selected
            const fileInput = document.getElementById('cabinets-file');
            if (fileInput.files[0]) {
                document.getElementById('preview-cabinets-btn').disabled = false;
                document.getElementById('import-cabinets-confirm-btn').disabled = false;
            }
            
            openModal('bulk-import-cabinets-modal');
        }

        function handleCabinetsFileSelect(event) {
            const file = event.target.files[0];
            const sessionSelect = document.getElementById('cabinet-session-select');
            
            if (!file) {
                document.getElementById('preview-cabinets-btn').disabled = true;
                document.getElementById('import-cabinets-confirm-btn').disabled = true;
                document.getElementById('cabinets-preview-section').classList.add('hidden');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('Please select a CSV file', 'error');
                event.target.value = '';
                return;
            }

            // Enable buttons if session is selected
            const hasSession = sessionSelect.value;
            document.getElementById('preview-cabinets-btn').disabled = !hasSession;
            document.getElementById('import-cabinets-confirm-btn').disabled = !hasSession;
            document.getElementById('cabinets-preview-section').classList.add('hidden');
        }

        function previewCabinets() {
            const fileInput = document.getElementById('cabinets-file');
            const sessionSelect = document.getElementById('cabinet-session-select');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a CSV file first', 'error');
                return;
            }
            
            if (!sessionSelect.value) {
                showMessage('Please select a PM session first', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showMessage('CSV file must have at least a header row and one data row', 'error');
                        return;
                    }

                    // Parse and validate CSV
                    const parsedData = parseCabinetsCSV(csvText);
                    if (!parsedData.success) {
                        showMessage(parsedData.error, 'error');
                        return;
                    }

                    cabinetsFileData = parsedData.data;
                    
                    // Show preview
                    const previewLines = lines.slice(0, 6); // Header + 5 rows
                    document.getElementById('cabinets-preview-content').textContent = previewLines.join('\n');
                    document.getElementById('cabinets-preview-stats').textContent = 
                        `Found ${parsedData.data.length} cabinets to import`;
                    
                    document.getElementById('cabinets-preview-section').classList.remove('hidden');
                    document.getElementById('import-cabinets-confirm-btn').disabled = false;
                    
                } catch (error) {
                    showMessage('Error reading CSV file: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function parseCabinetsCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    return { success: false, error: 'CSV file must have at least a header row and one data row' };
                }

                const header = lines[0].toLowerCase().split(',').map(h => h.trim());
                
                // Validate required columns
                const requiredColumns = ['cabinet_location'];
                const missingColumns = requiredColumns.filter(col => !header.includes(col));
                
                if (missingColumns.length > 0) {
                    return { 
                        success: false, 
                        error: `Missing required columns: ${missingColumns.join(', ')}. Expected: cabinet_location,cabinet_date` 
                    };
                }

                const cabinets = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim());
                    
                    if (values.length < header.length) {
                        // Pad with empty values if needed
                        while (values.length < header.length) {
                            values.push('');
                        }
                    }

                    const cabinet = {};
                    header.forEach((col, index) => {
                        cabinet[col] = values[index] || '';
                    });

                    if (cabinet.cabinet_location) { // Only add if location is provided
                        cabinets.push({
                            cabinet_location: cabinet.cabinet_location,
                            cabinet_date: cabinet.cabinet_date || new Date().toISOString().split('T')[0]
                        });
                    }
                }

                if (cabinets.length === 0) {
                    return { success: false, error: 'No valid cabinet data found in CSV' };
                }

                return { success: true, data: cabinets };
            } catch (error) {
                return { success: false, error: 'Error parsing CSV: ' + error.message };
            }
        }

        async function importCabinets() {
            const sessionSelect = document.getElementById('cabinet-session-select');
            
            // If no parsed data yet, try to parse from file
            if (!cabinetsFileData || cabinetsFileData.length === 0) {
                const fileInput = document.getElementById('cabinets-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    showMessage('Please select a CSV file first', 'error');
                    return;
                }
                
                // Parse the file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const parsedData = parseCabinetsCSV(csvText);
                        if (!parsedData.success) {
                            showMessage(parsedData.error, 'error');
                            return;
                        }
                        cabinetsFileData = parsedData.data;
                        importCabinets(); // Retry import with parsed data
                    } catch (error) {
                        showMessage('Error reading CSV file: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
                return;
            }
            
            if (!sessionSelect.value) {
                showMessage('Please select a PM session', 'error');
                return;
            }

            // Show progress
            document.getElementById('cabinets-import-progress-section').classList.remove('hidden');
            document.getElementById('import-cabinets-confirm-btn').disabled = true;
            
            const progressBar = document.getElementById('cabinets-progress-bar');
            const progressText = document.getElementById('cabinets-progress-text');
            const progressPercentage = document.getElementById('cabinets-progress-percentage');
            const importStatus = document.getElementById('cabinets-import-status');

            try {
                const response = await fetch('/api/cabinets/bulk-import', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        cabinets: cabinetsFileData,
                        session_id: sessionSelect.value
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Simulate progress for better UX
                    let progress = 0;
                    const interval = setInterval(() => {
                        progress += 10;
                        progressBar.style.width = progress + '%';
                        progressPercentage.textContent = progress + '%';
                        
                        if (progress >= 100) {
                            clearInterval(interval);
                            setTimeout(() => {
                                closeModal('bulk-import-cabinets-modal');
                                loadCustomerDetail(currentCustomer.id); // Refresh data
                                showMessage(`Successfully imported ${result.imported} cabinets`, 'success');
                                
                                // Reset form
                                document.getElementById('cabinets-file').value = '';
                                document.getElementById('cabinet-session-select').value = '';
                                document.getElementById('cabinets-preview-section').classList.add('hidden');
                                document.getElementById('cabinets-import-progress-section').classList.add('hidden');
                                document.getElementById('preview-cabinets-btn').disabled = true;
                                document.getElementById('import-cabinets-confirm-btn').disabled = true;
                                cabinetsFileData = null;
                            }, 500);
                        }
                    }, 100);
                } else {
                    throw new Error(result.error || 'Import failed');
                }
            } catch (error) {
                document.getElementById('cabinets-import-progress-section').classList.add('hidden');
                document.getElementById('import-cabinets-confirm-btn').disabled = false;
                showMessage('Error importing cabinets: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
